<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Anki macOS Pro</title>
    
    <!-- PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#F2F2F7" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#000000" media="(prefers-color-scheme: dark)">

    <!-- Libraries -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.9/purify.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <script>
        tailwind.config = {
            darkMode: 'media',
            theme: {
                extend: {
                    colors: {
                        ios: {
                            blue: '#007AFF',
                            green: '#34C759',
                            red: '#FF3B30',
                            orange: '#FF9500',
                            yellow: '#FFCC00',
                            gray: '#8E8E93',
                            gray2: '#AEAEB2',
                            bg: '#F2F2F7',
                            darkBg: '#000000',
                            card: '#FFFFFF',
                            darkCard: '#1C1C1E',
                            separator: '#C6C6C8',
                            darkSeparator: '#38383A'
                        }
                    },
                    boxShadow: {
                        'native': '0 4px 12px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04)',
                        'float': '0 8px 24px rgba(0,0,0,0.12)'
                    },
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', 'SF Pro Text', 'Helvetica Neue', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        /* Global Reset & Typography */
        body {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            overscroll-behavior-y: none; /* Pull-to-refreshni o'chiradi */
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            user-select: none; /* App kabi ishlashi uchun */
        }
        
        input, textarea {
            user-select: text; /* Yozish uchun ruxsat */
        }

        /* 3D Flip Animation */
        .card-container {
            perspective: 1200px;
        }
        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
            transform-style: preserve-3d;
        }
        .card-flipped {
            transform: rotateY(180deg);
        }
        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            overflow-y: auto;
        }
        .card-back {
            transform: rotateY(180deg);
        }

        /* Cloze Styles - Enhanced */
        .cloze-hidden {
            color: transparent;
            background: #007AFF;
            border-radius: 6px;
            padding: 2px 8px;
            font-weight: 600;
            cursor: pointer;
            position: relative;
            display: inline-block;
            min-width: 30px;
        }
        .cloze-hidden::after {
            content: '...';
            color: white;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.9em;
        }
        
        .dark .cloze-hidden {
            background: #0A84FF;
        }

        .cloze-revealed {
            color: #34C759;
            font-weight: 700;
            border-bottom: 2px solid rgba(52, 199, 89, 0.3);
            padding: 0 2px;
        }
        
        /* Animations */
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .animate-enter { animation: slideUp 0.3s ease-out; }

        /* Loader */
        .loader {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(128,128,128,0.2);
            border-top-color: #007AFF;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        ::-webkit-scrollbar { width: 0; height: 0; }
    </style>
</head>
<body class="bg-ios-bg dark:bg-black text-black dark:text-white transition-colors duration-300">
    <div id="root" class="h-screen w-full flex flex-col overflow-hidden"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback, Fragment } = React;

        // ==========================================
        // 1. HELPERS & ID GENERATOR
        // ==========================================
        
        // Robust ID generator (No crypto dependency)
        const generateId = () => {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        };

        const sanitize = (text) => {
            // Convert newlines to <br> first
            const html = text.replace(/\n/g, '<br>');
            return DOMPurify.sanitize(html, {
                ALLOWED_TAGS: ['b', 'i', 'u', 'strong', 'em', 'br', 'div', 'span', 'p', 'ul', 'li', 'code'],
                ALLOWED_ATTR: ['class', 'style']
            });
        };

        // ==========================================
        // 2. DATABASE (IndexedDB Singleton)
        // ==========================================
        const db = {
            name: 'AnkiPro_Final',
            version: 1,
            
            async connect() {
                return new Promise((resolve, reject) => {
                    const req = indexedDB.open(this.name, this.version);
                    req.onupgradeneeded = (e) => {
                        const d = e.target.result;
                        if (!d.objectStoreNames.contains('decks')) d.createObjectStore('decks', { keyPath: 'id' });
                        if (!d.objectStoreNames.contains('cards')) {
                            const s = d.createObjectStore('cards', { keyPath: 'id' });
                            s.createIndex('deckId', 'deckId', { unique: false });
                        }
                    };
                    req.onsuccess = (e) => resolve(e.target.result);
                    req.onerror = (e) => reject(e);
                });
            },

            async getDecks() {
                const conn = await this.connect();
                return new Promise(resolve => {
                    conn.transaction('decks', 'readonly').objectStore('decks').getAll().onsuccess = (e) => resolve(e.target.result || []);
                });
            },

            async addDeck(name) {
                const conn = await this.connect();
                const deck = { id: generateId(), name, created: Date.now() };
                return new Promise(resolve => {
                    const tx = conn.transaction('decks', 'readwrite');
                    tx.objectStore('decks').add(deck);
                    tx.oncomplete = () => resolve(deck);
                });
            },

            async deleteDeck(id) {
                const conn = await this.connect();
                return new Promise(resolve => {
                    const tx = conn.transaction(['decks', 'cards'], 'readwrite');
                    tx.objectStore('decks').delete(id);
                    const index = tx.objectStore('cards').index('deckId');
                    index.openCursor(IDBKeyRange.only(id)).onsuccess = (e) => {
                        const cursor = e.target.result;
                        if (cursor) { cursor.delete(); cursor.continue(); }
                    };
                    tx.oncomplete = () => resolve();
                });
            },

            async addCard(card) {
                const conn = await this.connect();
                return new Promise(resolve => {
                    const tx = conn.transaction('cards', 'readwrite');
                    tx.objectStore('cards').add(card);
                    tx.oncomplete = () => resolve();
                });
            },

            async getDueCards(deckId) {
                const conn = await this.connect();
                return new Promise(resolve => {
                    const tx = conn.transaction('cards', 'readonly');
                    const index = tx.objectStore('cards').index('deckId');
                    index.getAll(deckId).onsuccess = (e) => {
                        const all = e.target.result || [];
                        const now = Date.now();
                        // Sort: Due date first
                        const due = all.filter(c => c.due <= now).sort((a, b) => a.due - b.due);
                        resolve(due);
                    };
                });
            },

            async updateCard(card) {
                const conn = await this.connect();
                return new Promise(resolve => {
                    conn.transaction('cards', 'readwrite').objectStore('cards').put(card).onsuccess = () => resolve();
                });
            },
            
            async getStats() {
                const conn = await this.connect();
                return new Promise(async resolve => {
                    const dCount = await new Promise(r => conn.transaction('decks').objectStore('decks').count().onsuccess = e => r(e.target.result));
                    const cCount = await new Promise(r => conn.transaction('cards').objectStore('cards').count().onsuccess = e => r(e.target.result));
                    resolve({ decks: dCount, cards: cCount });
                });
            }
        };

        // ==========================================
        // 3. ADVANCED ALGORITHM (SM-2 ENHANCED)
        // ==========================================
        const scheduler = (card, rating) => {
            // Rating: 1=Again, 2=Hard, 3=Good, 4=Easy
            let { interval, ease, reps, phase } = card;
            const now = Date.now();
            const min = 60 * 1000;
            const day = 24 * 60 * 60 * 1000;

            // Phase: 'learning' | 'review'
            // Learning Steps: 1min -> 10min -> Graduated (1 day)

            let nextDue;

            if (rating === 1) { // AGAIN (Forgot)
                phase = 'learning';
                interval = 0; // 1 min step
                reps = 0;
                ease = Math.max(130, ease - 20);
                nextDue = now + min; // Due in 1 min
            } else {
                if (phase === 'learning') {
                    if (rating === 2) { // Hard (Stay in learning 10min)
                        nextDue = now + (10 * min);
                    } else if (rating === 3) { // Good (Graduate to 1 day)
                        phase = 'review';
                        interval = 1;
                        nextDue = now + day;
                    } else if (rating === 4) { // Easy (Graduate to 4 days)
                        phase = 'review';
                        interval = 4;
                        ease += 15;
                        nextDue = now + (4 * day);
                    }
                } else {
                    // Review Phase
                    if (rating === 2) { // Hard
                        interval = Math.max(1, interval * 1.2);
                        ease -= 15;
                    } else if (rating === 3) { // Good
                        interval = Math.round(interval * (ease / 100));
                    } else if (rating === 4) { // Easy
                        interval = Math.round(interval * (ease / 100) * 1.3);
                        ease += 15;
                    }
                    
                    if (interval < 1) interval = 1;
                    ease = Math.max(130, ease); // Minimum ease 130%
                    nextDue = now + (interval * day);
                }
                reps += 1;
            }

            return { ...card, interval, ease, reps, phase, due: nextDue, lastReview: now };
        };

        // ==========================================
        // 4. COMPONENTS
        // ==========================================

        const Header = ({ title, left, right }) => (
            <div className="h-14 bg-ios-bg/80 dark:bg-black/80 backdrop-blur-xl border-b border-ios-separator dark:border-ios-darkSeparator flex items-center justify-between px-4 sticky top-0 z-50 pt-[env(safe-area-inset-top)] transition-colors">
                <div className="w-16 flex items-center">{left}</div>
                <h1 className="font-semibold text-[17px] truncate tracking-tight">{title}</h1>
                <div className="w-16 flex justify-end items-center">{right}</div>
            </div>
        );

        const TabBar = ({ active, onChange }) => (
            <div className="h-[83px] bg-ios-bg/80 dark:bg-ios-darkCard/90 backdrop-blur-xl border-t border-ios-separator dark:border-ios-darkSeparator flex justify-around items-start pt-2 pb-[env(safe-area-inset-bottom)] fixed bottom-0 w-full z-50 transition-colors">
                <button onClick={() => onChange('decks')} className={`flex flex-col items-center gap-1 w-20 transition-all active:scale-95 ${active === 'decks' ? 'text-ios-blue' : 'text-ios-gray'}`}>
                    <i className="fas fa-layer-group text-xl mb-0.5"></i>
                    <span className="text-[10px] font-medium">Decks</span>
                </button>
                <button onClick={() => onChange('add')} className={`flex flex-col items-center gap-1 w-20 transition-all active:scale-95 ${active === 'add' ? 'text-ios-blue' : 'text-ios-gray'}`}>
                    <i className="fas fa-plus-circle text-xl mb-0.5"></i>
                    <span className="text-[10px] font-medium">Add</span>
                </button>
                <button onClick={() => onChange('stats')} className={`flex flex-col items-center gap-1 w-20 transition-all active:scale-95 ${active === 'stats' ? 'text-ios-blue' : 'text-ios-gray'}`}>
                    <i className="fas fa-chart-bar text-xl mb-0.5"></i>
                    <span className="text-[10px] font-medium">Stats</span>
                </button>
            </div>
        );

        // --- Decks View ---
        const Decks = ({ onSelect }) => {
            const [list, setList] = useState([]);
            const [loading, setLoading] = useState(true);
            const [modal, setModal] = useState(false);
            const [name, setName] = useState('');

            const load = async () => {
                const data = await db.getDecks();
                setList(data);
                setLoading(false);
            };

            useEffect(() => { load(); }, []);

            const create = async () => {
                if(!name.trim()) return;
                await db.addDeck(name);
                setName('');
                setModal(false);
                load();
            };

            const remove = async (e, id) => {
                e.stopPropagation();
                if(confirm('Delete deck and all cards inside?')) {
                    await db.deleteDeck(id);
                    load();
                }
            };

            return (
                <div className="flex flex-col h-full pb-24">
                    <Header title="Decks" right={<button onClick={() => setModal(true)} className="text-ios-blue text-2xl active:opacity-50 transition-opacity"><i className="fas fa-plus"></i></button>} />
                    
                    <div className="p-4 space-y-3 flex-1 overflow-y-auto">
                        {loading ? <div className="flex justify-center mt-10"><div className="loader"></div></div> : 
                         list.length === 0 ? <div className="text-center mt-20 text-ios-gray opacity-70"><i className="fas fa-folder-open text-4xl mb-4"></i><p>No decks found.</p></div> :
                         list.map(d => (
                            <div key={d.id} onClick={() => onSelect(d)} className="bg-ios-card dark:bg-ios-darkCard p-4 rounded-xl shadow-native flex justify-between items-center active:scale-[0.98] transition-all cursor-pointer group border border-transparent dark:border-ios-darkSeparator">
                                <div className="flex items-center gap-4">
                                    <div className="w-10 h-10 bg-ios-blue/10 dark:bg-ios-blue/20 rounded-full flex items-center justify-center text-ios-blue">
                                        <i className="fas fa-book"></i>
                                    </div>
                                    <span className="font-semibold text-[17px]">{d.name}</span>
                                </div>
                                <button onClick={(e) => remove(e, d.id)} className="w-8 h-8 flex items-center justify-center text-ios-gray2 hover:text-ios-red transition-colors">
                                    <i className="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        ))}
                        
                        <div className="mt-8 text-center opacity-40">
                            <p className="text-xs font-medium text-ios-gray">Made by Muhammad Daler</p>
                        </div>
                    </div>

                    {modal && (
                        <div className="fixed inset-0 bg-black/40 z-[100] flex items-center justify-center p-6 backdrop-blur-sm animate-enter">
                            <div className="bg-ios-card dark:bg-ios-darkCard w-full max-w-sm rounded-2xl p-6 shadow-float">
                                <h3 className="text-lg font-bold mb-4 text-center">Create New Deck</h3>
                                <input value={name} onChange={e => setName(e.target.value)} placeholder="e.g., English Vocabulary" className="w-full bg-ios-bg dark:bg-black p-3 rounded-xl mb-4 outline-none border-none focus:ring-2 focus:ring-ios-blue" autoFocus />
                                <div className="flex gap-3">
                                    <button onClick={() => setModal(false)} className="flex-1 py-3 bg-ios-bg dark:bg-gray-800 rounded-xl text-ios-blue font-semibold">Cancel</button>
                                    <button onClick={create} className="flex-1 py-3 bg-ios-blue text-white rounded-xl font-semibold shadow-lg">Create</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- Add Card View ---
        const AddCard = () => {
            const [decks, setDecks] = useState([]);
            const [deckId, setDeckId] = useState('');
            const [type, setType] = useState('basic');
            const [front, setFront] = useState('');
            const [back, setBack] = useState('');
            const [msg, setMsg] = useState(null);
            const frontRef = useRef(null);

            useEffect(() => {
                db.getDecks().then(d => { setDecks(d); if(d.length) setDeckId(d[0].id); });
            }, []);

            const insertCloze = () => {
                const el = frontRef.current;
                if(!el) return;
                const txt = el.value;
                const start = el.selectionStart;
                const end = el.selectionEnd;
                const sel = txt.substring(start, end) || '...';
                
                // Find next number
                const matches = txt.match(/{{c(\d+)::/g);
                let next = 1;
                if(matches) {
                    const nums = matches.map(m => parseInt(m.match(/\d+/)[0]));
                    next = Math.max(...nums) + 1;
                }
                
                const newTxt = txt.substring(0, start) + `{{c${next}::${sel}}}` + txt.substring(end);
                setFront(newTxt);
                
                setTimeout(() => {
                    el.focus();
                    const newCursor = start + 5 + next.toString().length + sel.length + 2; // Approximate cursor placement
                    el.setSelectionRange(newCursor, newCursor);
                }, 10);
            };

            const save = async () => {
                if(!deckId || !front.trim()) {
                    setMsg({txt: "Please select a deck and fill the front field.", err: true});
                    setTimeout(() => setMsg(null), 3000);
                    return;
                }

                const base = {
                    deckId,
                    type,
                    created: Date.now(),
                    due: Date.now(),
                    interval: 0,
                    ease: 250, // 250%
                    reps: 0,
                    phase: 'learning'
                };

                if(type === 'basic') {
                    await db.addCard({ ...base, id: generateId(), front: front, back: back });
                } else {
                    const regex = /{{c(\d+)::.*?}}/g;
                    const matches = [...front.matchAll(regex)];
                    const ids = [...new Set(matches.map(m => m[1]))];
                    
                    if(ids.length === 0) {
                        setMsg({txt: "No cloze found. Use the {...} button.", err: true});
                        setTimeout(() => setMsg(null), 3000);
                        return;
                    }

                    for(let cid of ids) {
                        await db.addCard({ 
                            ...base, 
                            id: generateId(), 
                            front: front, 
                            back: back,
                            clozeId: cid 
                        });
                    }
                }

                setMsg({txt: "Card Added Successfully!", err: false});
                setFront('');
                setBack('');
                setTimeout(() => setMsg(null), 2000);
            };

            return (
                <div className="flex flex-col h-full pb-24">
                    <Header title="Add Card" />
                    {msg && <div className={`fixed top-20 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full text-white text-sm font-bold shadow-float z-[100] animate-enter ${msg.err ? 'bg-ios-red' : 'bg-ios-green'}`}>{msg.txt}</div>}
                    
                    <div className="p-4 space-y-6 overflow-y-auto flex-1">
                        <div className="bg-ios-card dark:bg-ios-darkCard rounded-xl p-4 shadow-native">
                            <label className="text-xs font-bold text-ios-gray uppercase mb-2 block tracking-wider">Target Deck</label>
                            <select value={deckId} onChange={e => setDeckId(e.target.value)} className="w-full bg-ios-bg dark:bg-black p-3 rounded-xl outline-none mb-4 appearance-none">
                                {decks.map(d => <option key={d.id} value={d.id}>{d.name}</option>)}
                            </select>

                            <label className="text-xs font-bold text-ios-gray uppercase mb-2 block tracking-wider">Card Type</label>
                            <div className="flex bg-ios-bg dark:bg-black p-1 rounded-xl">
                                <button onClick={() => setType('basic')} className={`flex-1 py-2 rounded-lg text-sm font-semibold transition-all ${type==='basic' ? 'bg-white dark:bg-gray-700 shadow-sm text-black dark:text-white' : 'text-ios-gray'}`}>Basic</button>
                                <button onClick={() => setType('cloze')} className={`flex-1 py-2 rounded-lg text-sm font-semibold transition-all ${type==='cloze' ? 'bg-white dark:bg-gray-700 shadow-sm text-black dark:text-white' : 'text-ios-gray'}`}>Cloze</button>
                            </div>
                        </div>

                        <div className="bg-ios-card dark:bg-ios-darkCard rounded-xl p-4 shadow-native space-y-4">
                            <div className="relative">
                                <div className="flex justify-between items-center mb-2">
                                    <label className="text-xs font-bold text-ios-gray uppercase tracking-wider">Front</label>
                                    {type === 'cloze' && <button onClick={insertCloze} className="text-xs bg-ios-blue text-white px-3 py-1 rounded-full font-bold shadow-sm active:scale-95 transition-transform">{`{...}`}</button>}
                                </div>
                                <textarea ref={frontRef} value={front} onChange={e => setFront(e.target.value)} className="w-full bg-transparent border-b border-ios-separator dark:border-ios-darkSeparator min-h-[100px] outline-none resize-none pb-2 text-[17px] leading-relaxed" placeholder="Type your question here..." />
                            </div>
                            <div>
                                <label className="text-xs font-bold text-ios-gray uppercase mb-2 block tracking-wider">Back (Extra)</label>
                                <textarea value={back} onChange={e => setBack(e.target.value)} className="w-full bg-transparent min-h-[60px] outline-none resize-none text-[17px] leading-relaxed" placeholder="Extra notes (optional)..." />
                            </div>
                        </div>

                        <button onClick={save} className="w-full bg-ios-blue text-white py-4 rounded-xl font-bold text-[17px] shadow-lg active:scale-[0.98] transition-transform">
                            Add to Deck
                        </button>
                    </div>
                </div>
            );
        };

        // --- Study View ---
        const Study = ({ deck, onBack }) => {
            const [cards, setCards] = useState([]);
            const [index, setIndex] = useState(0);
            const [flipped, setFlipped] = useState(false);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                db.getDueCards(deck.id).then(c => { setCards(c); setLoading(false); });
            }, [deck]);

            const rate = async (r) => {
                const card = cards[index];
                const updated = scheduler(card, r);
                await db.updateCard(updated);
                
                setFlipped(false);
                if(index < cards.length - 1) {
                    setTimeout(() => setIndex(i => i + 1), 250);
                } else {
                    setCards([]);
                }
            };

            const renderCloze = (text, targetId, isBack) => {
                // Regex handles hints: {{c1::Answer::Hint}}
                return sanitize(text).replace(/{{c(\d+)::(.*?)(?:::(.*?))?}}/g, (match, id, answer, hint) => {
                    // Logic: If this is the target Cloze ID (e.g. c1)
                    if(id === targetId) {
                        if(isBack) return `<span class="cloze-revealed">${answer}</span>`;
                        return `<span class="cloze-hidden" title="${hint || ''}">${hint || ''}</span>`;
                    }
                    // For other clozes (c2, c3), we usually show the answer in context or keep them hidden?
                    // Anki standard: Only target is hidden, others are shown.
                    return `<strong>${answer}</strong>`;
                });
            };

            if(loading) return <div className="h-full flex items-center justify-center"><div className="loader"></div></div>;

            if(cards.length === 0) return (
                <div className="h-full flex flex-col items-center justify-center p-6 bg-ios-bg dark:bg-black text-center animate-enter">
                    <div className="w-24 h-24 bg-ios-green/20 rounded-full flex items-center justify-center mb-6 shadow-sm"><i className="fas fa-check text-4xl text-ios-green"></i></div>
                    <h2 className="text-3xl font-bold mb-3">All Caught Up!</h2>
                    <p className="text-ios-gray text-lg mb-8">You have no more cards to review.</p>
                    <button onClick={onBack} className="bg-ios-card dark:bg-ios-darkCard text-ios-blue font-semibold px-10 py-4 rounded-xl shadow-native active:scale-95 transition-transform">Return to Decks</button>
                </div>
            );

            const active = cards[index];
            const isCloze = active.type === 'cloze';

            return (
                <div className="flex flex-col h-full bg-ios-bg dark:bg-black">
                    <Header title={`${index + 1} / ${cards.length}`} left={<button onClick={onBack} className="text-ios-blue flex items-center gap-1 font-medium"><i className="fas fa-chevron-left"></i> Back</button>} />
                    
                    <div className="flex-1 p-4 relative flex flex-col justify-center card-container">
                        <div className={`card-inner w-full min-h-[400px] flex-1 cursor-pointer ${flipped ? 'card-flipped' : ''}`} onClick={() => !flipped && setFlipped(true)}>
                            
                            {/* FRONT FACE */}
                            <div className="card-face bg-ios-card dark:bg-ios-darkCard rounded-3xl shadow-float p-8 flex flex-col items-center justify-center text-center border border-transparent dark:border-ios-darkSeparator">
                                <div className="text-2xl md:text-3xl font-medium leading-relaxed max-w-full break-words">
                                    {isCloze 
                                        ? <div dangerouslySetInnerHTML={{__html: renderCloze(active.front, active.clozeId, false)}} /> 
                                        : <div dangerouslySetInnerHTML={{__html: sanitize(active.front)}} />
                                    }
                                </div>
                                <div className="mt-8 text-sm text-ios-gray uppercase font-bold tracking-widest opacity-60">Tap to show answer</div>
                            </div>

                            {/* BACK FACE */}
                            <div className="card-face card-back bg-ios-card dark:bg-ios-darkCard rounded-3xl shadow-float p-8 flex flex-col items-center justify-center text-center border border-transparent dark:border-ios-darkSeparator">
                                <div className="text-xl opacity-60 mb-6 pb-6 border-b border-ios-separator dark:border-ios-darkSeparator w-full">
                                    {isCloze 
                                        ? <div dangerouslySetInnerHTML={{__html: renderCloze(active.front, active.clozeId, true)}} /> 
                                        : <div dangerouslySetInnerHTML={{__html: sanitize(active.front)}} />
                                    }
                                </div>
                                <div className="text-2xl md:text-3xl font-semibold leading-relaxed">
                                    <div dangerouslySetInnerHTML={{__html: sanitize(active.back)}} />
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* CONTROLS */}
                    <div className="bg-ios-bg/90 dark:bg-black/90 backdrop-blur-xl border-t border-ios-separator dark:border-ios-darkSeparator pb-[env(safe-area-inset-bottom)] px-4 py-4">
                        {!flipped ? (
                            <button onClick={() => setFlipped(true)} className="w-full bg-ios-blue text-white h-14 rounded-2xl font-bold text-lg shadow-lg active:scale-[0.98] transition-transform">Show Answer</button>
                        ) : (
                            <div className="grid grid-cols-4 gap-3 w-full">
                                <button onClick={() => rate(1)} className="flex flex-col items-center justify-center bg-ios-red/10 h-16 rounded-2xl active:scale-95 transition-transform"><span className="text-ios-red font-bold text-sm">Again</span><span className="text-[10px] text-ios-gray mt-1">1m</span></button>
                                <button onClick={() => rate(2)} className="flex flex-col items-center justify-center bg-ios-orange/10 h-16 rounded-2xl active:scale-95 transition-transform"><span className="text-ios-orange font-bold text-sm">Hard</span><span className="text-[10px] text-ios-gray mt-1">10m</span></button>
                                <button onClick={() => rate(3)} className="flex flex-col items-center justify-center bg-ios-green/10 h-16 rounded-2xl active:scale-95 transition-transform"><span className="text-ios-green font-bold text-sm">Good</span><span className="text-[10px] text-ios-gray mt-1">1d</span></button>
                                <button onClick={() => rate(4)} className="flex flex-col items-center justify-center bg-ios-blue/10 h-16 rounded-2xl active:scale-95 transition-transform"><span className="text-ios-blue font-bold text-sm">Easy</span><span className="text-[10px] text-ios-gray mt-1">4d</span></button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- Stats View ---
        const Stats = () => {
            const [data, setData] = useState({decks: 0, cards: 0});
            useEffect(() => { db.getStats().then(setData); }, []);
            return (
                <div className="flex flex-col h-full bg-ios-bg dark:bg-black">
                    <Header title="Statistics" />
                    <div className="p-4 grid grid-cols-2 gap-4">
                        <div className="bg-ios-card dark:bg-ios-darkCard p-6 rounded-2xl shadow-native flex flex-col items-center">
                            <span className="text-4xl font-bold mb-2 text-ios-blue">{data.decks}</span>
                            <span className="text-xs text-ios-gray uppercase font-bold tracking-wider">Total Decks</span>
                        </div>
                        <div className="bg-ios-card dark:bg-ios-darkCard p-6 rounded-2xl shadow-native flex flex-col items-center">
                            <span className="text-4xl font-bold mb-2 text-ios-green">{data.cards}</span>
                            <span className="text-xs text-ios-gray uppercase font-bold tracking-wider">Total Cards</span>
                        </div>
                    </div>
                    
                    <div className="mt-auto mb-24 text-center opacity-40">
                         <p className="text-xs font-medium text-ios-gray">Made by Muhammad Daler</p>
                    </div>
                </div>
            );
        };

        // --- Main App ---
        const App = () => {
            const [tab, setTab] = useState('decks');
            const [activeDeck, setActiveDeck] = useState(null);

            useEffect(() => {
                if(window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.documentElement.classList.add('dark');
                }
            }, []);

            if(activeDeck) return <Study deck={activeDeck} onBack={() => setActiveDeck(null)} />;

            return (
                <Fragment>
                    <div className="flex-1 overflow-hidden relative">
                        {tab === 'decks' && <Decks onSelect={setActiveDeck} />}
                        {tab === 'add' && <AddCard />}
                        {tab === 'stats' && <Stats />}
                    </div>
                    <TabBar active={tab} onChange={setTab} />
                </Fragment>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>