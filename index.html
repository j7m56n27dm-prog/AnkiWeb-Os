<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Anki Pro — SM-2 & Cloze++ (Tuzatilgan, Dark mode)</title>

    <!-- Tailwind (CDN) va Font Awesome -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        /* --- Theme variables --- */
        :root{
            --anki-blue: #007AFF;
            --anki-green: #34C759;
            --anki-red: #FF3B30;
            --bg-light: #F5F5F7;
            --card-light: #FFFFFF;
            --border-light: #D1D1D6;
            --text-light: #1D1D1F;
            --bg-dark: #0f1113;
            --card-dark: #161619;
            --border-dark: #2a2a2c;
            --text-dark: #ECECEC;
        }

        html.light { --bg: var(--bg-light); --card: var(--card-light); --border: var(--border-light); --text: var(--text-light); }
        html.dark  { --bg: var(--bg-dark);  --card: var(--card-dark);  --border: var(--border-dark);  --text: var(--text-dark); }

        body{
            margin:0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: var(--bg); color: var(--text); min-height:100vh; display:flex; flex-direction:column; overflow:hidden;
        }

        header{ height:56px; display:flex; align-items:center; justify-content:space-between; padding:0 18px; border-bottom:1px solid var(--border); background:transparent; }
        .nav-button{ padding:6px 12px; border-radius:8px; }
        .nav-button.active{ background: rgba(0,0,0,0.06); font-weight:600; }

        main{ flex:1; overflow:auto; padding:22px; }

        .card-display{ border-radius:12px; padding:28px; min-height:260px; border:1px solid var(--border); background:var(--card); box-shadow:0 8px 30px rgba(0,0,0,0.08); display:flex; align-items:center; justify-content:center; text-align:center; }

        .editor-field{ min-height:92px; padding:10px; border-radius:8px; border:1px solid var(--border); background:var(--card); color:var(--text); outline:none; }
        .editor-field:focus{ box-shadow:0 0 0 4px rgba(0,122,255,0.06); border-color:var(--anki-blue); }

        .cloze-hidden{ color: var(--anki-blue); font-weight:700; background: rgba(0,122,255,0.08); padding:0 6px; border-radius:4px; }
        .cloze-revealed{ color: var(--anki-green); font-weight:700; text-decoration:underline; }

        .table { width:100%; border-collapse:separate; border-spacing:0; }
        .table th{ text-align:left; font-size:12px; padding:10px 14px; color:#767676; border-bottom:1px solid var(--border); text-transform:uppercase; }
        .table td{ padding:12px 14px; border-bottom:1px solid var(--border); }

        #toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:28px; background:rgba(0,0,0,0.75); color:#fff; padding:10px 14px; border-radius:999px; opacity:0; pointer-events:none; transition:all .24s; z-index:60; }
        #toast.show{ opacity:1; pointer-events:auto; transform:translateX(-50%) translateY(0); }

        .fixed-bottom-controls{ position:fixed; left:0; right:0; bottom:0; padding:12px; border-top:1px solid var(--border); background: linear-gradient(180deg, rgba(0,0,0,0.02), transparent); backdrop-filter: blur(4px); }
    </style>
</head>
<body class="light">

<header>
    <div class="flex items-center gap-4">
        <i class="fa-solid fa-layer-group text-[20px]" style="color:var(--anki-blue)"></i>
        <h1 class="text-lg font-semibold">Anki Pro</h1>
        <nav class="hidden md:flex gap-2 ml-4" aria-label="Navigation">
            <button id="nav-decks" class="nav-button" onclick="Router.nav('decks')">Decklar</button>
            <button id="nav-add" class="nav-button" onclick="Router.nav('add')">Karta qo'shish</button>
            <button id="nav-browse" class="nav-button" onclick="Router.nav('browse')">Ko'rib chiqish</button>
            <button id="nav-stats" class="nav-button" onclick="Router.nav('stats')">Statistika</button>
        </nav>
    </div>

    <div class="flex items-center gap-2">
        <button onclick="Theme.toggle()" title="Tungi/yorug' rejim"><i id="theme-icon" class="fa-solid fa-moon"></i></button>
    </div>
</header>

<main id="app-viewport"></main>

<div id="toast" role="status" aria-live="polite">Amal bajarildi</div>

<script>
/* ======================
   YORDAMCHI FUNKSIYALAR
   ====================== */
const Utils = {
    id(){ return 'id_' + Date.now() + '_' + Math.random().toString(36).slice(2,9); },
    sanitize(s=''){ return String(s).replace(/</g,'&lt;').replace(/>/g,'&gt;'); },
    now(){ return Date.now(); },
    daysToMs(d){ return Math.round(d*24*60*60*1000); },
    formatTimeMs(ms){
        if(!ms || ms <= 0) return '0m';
        if(ms < 60000) return Math.round(ms/1000) + 's';
        if(ms < 3600000) return Math.round(ms/60000) + 'm';
        if(ms < 86400000) return Math.round(ms/3600000) + 'h';
        return Math.round(ms/86400000) + 'd';
    }
};

/* ======================
   THEME (Dark / Light)
   ====================== */
const Theme = {
    init(){
        const saved = localStorage.getItem('anki_theme_pref');
        const preferDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        if(saved === 'dark' || (!saved && preferDark)) {
            document.documentElement.classList.add('dark');
            document.body.classList.remove('light');
            document.body.classList.add('dark');
            document.getElementById('theme-icon').className = 'fa-solid fa-sun';
        } else {
            document.documentElement.classList.remove('dark');
            document.body.classList.remove('dark');
            document.body.classList.add('light');
            document.getElementById('theme-icon').className = 'fa-solid fa-moon';
        }
        // toggling CSS variables between .dark and .light classes on html handled in CSS rule earlier
    },
    toggle(){
        const isDark = document.body.classList.contains('dark');
        if(isDark){
            document.body.classList.remove('dark');
            document.body.classList.add('light');
            document.getElementById('theme-icon').className = 'fa-solid fa-moon';
            localStorage.setItem('anki_theme_pref','light');
        } else {
            document.body.classList.remove('light');
            document.body.classList.add('dark');
            document.getElementById('theme-icon').className = 'fa-solid fa-sun';
            localStorage.setItem('anki_theme_pref','dark');
        }
        // re-render stats if open
        if(Router.currentPage === 'stats') Router.renderStats(document.getElementById('app-viewport'));
    }
};

/* ======================
   DATABASE (localStorage)
   ====================== */
const DB = {
    key: 'anki_pro_db_v1',
    data: { decks: [], cards: [] },

    init(){
        const raw = localStorage.getItem(this.key);
        if(raw){
            try{
                const parsed = JSON.parse(raw);
                if(parsed && Array.isArray(parsed.decks) && Array.isArray(parsed.cards)){
                    this.data = parsed;
                } else throw new Error('Invalid DB');
            } catch(e){
                console.warn('DB corrupt, seeding defaults', e);
                this.seed();
            }
        } else {
            this.seed();
        }
        this.save();
    },

    save(){ localStorage.setItem(this.key, JSON.stringify(this.data)); },

    seed(){
        this.data = {
            decks: [
                { id:'d_default', name:'General Knowledge' },
                { id:'d_code', name:'Programming Concepts' }
            ],
            cards: [
                // SM-2 fields: ef (ease factor), reps (repetitions), interval (days)
                { id:'c1', deckId:'d_default', front:'O‘zbekiston poytaxti?', back:'Toshkent', type:'basic', due:Date.now(), ef:2.5, reps:0, interval:0, state:'new' },
                { id:'c2', deckId:'d_code', front:'{{c1::Closure}} — bu funksiya va uning leksik muhiti.', back:'', type:'cloze', due:Date.now(), ef:2.5, reps:0, interval:0, state:'new' }
            ]
        };
        this.save();
    },

    addDeck(name){ this.data.decks.push({ id: Utils.id(), name }); this.save(); },
    deleteDeck(id){ this.data.decks = this.data.decks.filter(d => d.id !== id); this.data.cards = this.data.cards.filter(c => c.deckId !== id); this.save(); },
    addCard(card){ this.data.cards.push(card); this.save(); },
    deleteCard(id){ this.data.cards = this.data.cards.filter(c => c.id !== id); this.save(); },
    getCounts(deckId){
        const now = Date.now();
        const cards = this.data.cards.filter(c => c.deckId === deckId);
        return {
            new: cards.filter(c => c.state === 'new').length,
            learning: cards.filter(c => c.state === 'learning').length,
            review: cards.filter(c => c.state === 'review' && (c.due || 0) <= now).length
        };
    }
};

/* ======================
   SM-2 Scheduler (Anki-like)
   ======================
   We use classic SM-2:
   - quality q in 0..5 (5 best). Map UI rating (1-4) to q: 1->0, 2->3, 3->4, 4->5
   - if q < 3: reps = 0, interval = 1 day
   - else:
       if reps == 0: interval = 1
       else if reps == 1: interval = 6
       else interval = Math.round(prevInterval * ef)
     reps += 1
   - update efactor: ef = ef + (0.1 - (5-q)*(0.08 + (5-q)*0.02)), ef >= 1.3
   - store interval in days, due = now + interval*24h
*/

const Scheduler = {
    mapRatingToQuality(r){
        // r: 1..4 from UI -> map to SM-2 q (0..5)
        if(r === 1) return 0; // Again -> totally fail
        if(r === 2) return 3; // Hard -> 3
        if(r === 3) return 4; // Good -> 4
        if(r === 4) return 5; // Easy -> 5
        return 0;
    },

    answer(card, rating){
        // card: object with ef, reps, interval (days)
        const q = this.mapRatingToQuality(rating);
        if(typeof card.ef !== 'number') card.ef = 2.5;
        if(typeof card.reps !== 'number') card.reps = 0;
        if(typeof card.interval !== 'number') card.interval = 0;

        if(q < 3){
            card.reps = 0;
            card.interval = 1; // days
            card.state = 'learning';
        } else {
            if(card.reps === 0) card.interval = 1;
            else if(card.reps === 1) card.interval = 6;
            else card.interval = Math.max(1, Math.round(card.interval * card.ef));
            card.reps += 1;
            card.state = 'review';
        }

        // update efactor
        const ef = card.ef + (0.1 - (5 - q) * (0.08 + (5 - q) * 0.02));
        card.ef = Math.max(1.3, Math.round((ef + Number.EPSILON) * 100) / 100);

        // due timestamp
        card.due = Date.now() + Utils.daysToMs(card.interval);

        return card;
    }
};

/* ======================
   ROUTER / RENDER
   ====================== */
const Router = {
    currentPage: 'decks',
    nav(page, param){
        this.currentPage = page;
        const vp = document.getElementById('app-viewport');
        vp.innerHTML = '';

        // nav button active state
        document.querySelectorAll('.nav-button').forEach(b => b.classList.remove('active'));
        const nb = document.getElementById('nav-' + page);
        if(nb) nb.classList.add('active');

        if(page === 'decks') this.renderDecks(vp);
        else if(page === 'add') this.renderAdd(vp);
        else if(page === 'study') this.renderStudy(vp, param);
        else if(page === 'browse') this.renderBrowse(vp);
        else if(page === 'stats') this.renderStats(vp);
        else this.renderDecks(vp);
    },

    renderDecks(root){
        const decks = DB.data.decks;
        const rows = decks.map(d => {
            const c = DB.getCounts(d.id);
            return `<tr class="hover:bg-[rgba(0,0,0,0.02)]">
                <td onclick="Router.nav('study','${d.id}')" style="cursor:pointer"><strong>${Utils.sanitize(d.name)}</strong></td>
                <td class="text-center">${c.new}</td>
                <td class="text-center">${c.learning}</td>
                <td class="text-center">${c.review}</td>
                <td class="text-right"><button onclick="Actions.confirmDeleteDeck('${d.id}')" title="O'chirish" class="text-red-500"><i class="fa-solid fa-trash-can"></i></button></td>
            </tr>`;
        }).join('');

        root.innerHTML = `
            <div class="max-w-4xl mx-auto space-y-6">
                <div class="bg-[var(--card)] border border-[var(--border)] rounded-xl p-2">
                    <table class="table w-full">
                        <thead><tr><th>Deck</th><th class="text-center">Yangi</th><th class="text-center">O'qilmoqda</th><th class="text-center">Due</th><th></th></tr></thead>
                        <tbody>${rows || '<tr><td colspan="5" class="p-6 text-center text-gray-500">Decklar topilmadi</td></tr>'}</tbody>
                    </table>
                </div>

                <div class="flex justify-center">
                    <button onclick="Actions.createDeck()" class="px-6 py-2 rounded bg-[var(--anki-blue)] text-white"><i class="fa-solid fa-plus mr-2"></i>Yangi Deck</button>
                </div>
            </div>`;
    },

    renderAdd(root){
        const deckOpts = DB.data.decks.map(d => `<option value="${d.id}">${Utils.sanitize(d.name)}</option>`).join('');
        root.innerHTML = `
            <div class="max-w-2xl mx-auto space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs font-semibold">Tip</label>
                        <select id="add-type" onchange="UI.toggleAddFields()" class="w-full p-2 border rounded editor-field">
                            <option value="basic">Basic</option>
                            <option value="cloze">Cloze</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-semibold">Deck</label>
                        <select id="add-deck" class="w-full p-2 border rounded editor-field">
                            ${deckOpts}
                        </select>
                    </div>
                </div>

                <div class="bg-[var(--card)] border border-[var(--border)] rounded-xl p-4">
                    <div class="flex gap-2 mb-3">
                        <button onclick="UI.format('bold')" title="Qalin">B</button>
                        <button onclick="UI.format('italic')" title="Kursiv">I</button>
                        <button onclick="UI.format('underline')" title="Tagi chizilgan">U</button>
                        <div class="flex-1"></div>
                        <button id="btn-cloze-insert" onclick="UI.insertCloze()" title="Cloze qo'shish" class="hidden">Cloze</button>
                    </div>

                    <div>
                        <label class="text-xs font-semibold">Old</label>
                        <div id="field-front" class="editor-field" contenteditable="true" placeholder="Matn..."></div>
                    </div>

                    <div id="container-back" class="mt-4">
                        <label class="text-xs font-semibold">Orqa (ixtiyoriy)</label>
                        <div id="field-back" class="editor-field" contenteditable="true"></div>
                    </div>
                </div>

                <div class="flex justify-end gap-2">
                    <button onclick="Router.nav('decks')" class="px-4 py-2 rounded border">Bekor</button>
                    <button onclick="Actions.addCard()" class="px-6 py-2 rounded bg-[var(--anki-blue)] text-white">Qo'shish</button>
                </div>
            </div>
        `;
        UI.toggleAddFields();
    },

    renderStudy(root, deckId){
        const now = Date.now();
        const queue = DB.data.cards.filter(c => c.deckId === deckId && (c.due || 0) <= now).sort((a,b) => (a.due || 0) - (b.due || 0));
        if(!queue.length){
            root.innerHTML = `
                <div class="max-w-3xl mx-auto text-center py-20">
                    <div class="text-3xl mb-2" style="color:var(--anki-green)"><i class="fa-solid fa-check"></i></div>
                    <h2 class="text-2xl font-semibold mb-2">Hammasi bajarildi</h2>
                    <p class="text-gray-500 mb-6">Bu deckda hozir ko'riladigan karta yo'q.</p>
                    <button onclick="Router.nav('decks')" class="px-6 py-2 rounded border">Decklarga qaytish</button>
                </div>`;
            return;
        }

        Study.activeCard = queue[0];
        Study.isAnswerShown = false;

        let frontHtml = Study.activeCard.front;
        if(Study.activeCard.type === 'cloze'){
            frontHtml = frontHtml.replace(/{{c(\d+)::(.*?)(?:::(.*?))?}}/g, (m, idx, ans, hint) => {
                const safeHint = hint ? Utils.sanitize(hint) : '...';
                return `<span class="cloze-hidden" data-cloze="${idx}">[${safeHint}]</span>`;
            });
        } else {
            frontHtml = Utils.sanitize(frontHtml).replace(/\n/g,'<br/>');
        }

        root.innerHTML = `
            <div class="max-w-3xl mx-auto space-y-4">
                <div class="flex justify-between items-center text-sm text-gray-500">
                    <div>Review</div>
                    <div>${queue.length} ta qoldi</div>
                </div>

                <div class="card-display">
                    <div id="card-front-content" class="w-full break-words">${frontHtml}</div>
                    <div id="answer-area" class="w-full hidden border-t border-[var(--border)] mt-6 pt-4">
                        <div id="card-back-content" class="w-full text-gray-400"></div>
                    </div>
                </div>
            </div>

            <div class="fixed-bottom-controls">
                <div class="max-w-3xl mx-auto flex gap-3 justify-center">
                    <button id="btn-show" onclick="Study.showAnswer()" class="px-8 py-3 rounded-xl bg-[var(--anki-blue)] text-white">Javobni ko'rsat</button>

                    <div id="btns-rate" class="hidden grid grid-cols-4 gap-2 w-full">
                        <!-- rating: 1(Again)->q=0, 2(Hard)->3, 3(Good)->4, 4(Easy)->5 -->
                        <button onclick="Study.rate(1)" class="p-3 rounded-lg border-2 border-[var(--anki-red)] text-[var(--anki-red)]">
                            <div class="text-xs">0</div><div class="font-bold">Yana</div>
                        </button>
                        <button onclick="Study.rate(2)" class="p-3 rounded-lg border border-gray-300">
                            <div class="text-xs">3</div><div class="font-bold">Qiyin</div>
                        </button>
                        <button onclick="Study.rate(3)" class="p-3 rounded-lg border-2 border-[var(--anki-green)] text-[var(--anki-green)]">
                            <div class="text-xs">4</div><div class="font-bold">Yaxshi</div>
                        </button>
                        <button onclick="Study.rate(4)" class="p-3 rounded-lg border-2 border-[var(--anki-blue)] text-[var(--anki-blue)]">
                            <div class="text-xs">5</div><div class="font-bold">Oson</div>
                        </button>
                    </div>
                </div>
            </div>
        `;
    },

    renderBrowse(root){
        const rows = DB.data.cards.map(c => {
            const deck = DB.data.decks.find(d => d.id === c.deckId);
            const deckName = deck ? Utils.sanitize(deck.name) : '—';
            const strip = html => {
                const tmp = document.createElement('DIV'); tmp.innerHTML = Utils.sanitize(html); return tmp.textContent || '';
            };
            return `<tr class="hover:bg-[rgba(0,0,0,0.02)]">
                <td style="max-width:260px; overflow:hidden; white-space:nowrap; text-overflow:ellipsis">${strip(c.front)}</td>
                <td style="max-width:260px; overflow:hidden; white-space:nowrap; text-overflow:ellipsis">${strip(c.back || (c.type === 'cloze' ? 'Cloze' : ''))}</td>
                <td class="hidden md:table-cell">${deckName}</td>
                <td>${new Date(c.due || Date.now()).toLocaleString()}</td>
                <td class="text-right"><button onclick="Actions.deleteCard('${c.id}')" class="text-red-500"><i class="fa-solid fa-trash"></i></button></td>
            </tr>`;
        }).join('');

        root.innerHTML = `
            <div class="max-w-6xl mx-auto">
                <div class="bg-[var(--card)] border border-[var(--border)] rounded-xl overflow-auto">
                    <table class="table w-full">
                        <thead><tr><th>Old</th><th>Orqa</th><th class="hidden md:table-cell">Deck</th><th>Due</th><th></th></tr></thead>
                        <tbody>${rows || '<tr><td colspan="5" class="p-6 text-center text-gray-500">Kartalar yo\'q</td></tr>'}</tbody>
                    </table>
                </div>
            </div>
        `;
    },

    renderStats(root){
        // Simple stats (no Chart.js included to keep file minimal); show numbers and sample pie with CSS
        const total = DB.data.cards.length;
        const newCount = DB.data.cards.filter(c => c.state === 'new').length;
        const learning = DB.data.cards.filter(c => c.state === 'learning').length;
        const review = DB.data.cards.filter(c => c.state === 'review').length;

        root.innerHTML = `
            <div class="max-w-4xl mx-auto">
                <h2 class="text-2xl font-semibold mb-4">Statistika</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-[var(--card)] border border-[var(--border)] p-4 rounded-xl">
                        <div class="flex justify-between mb-2"><div>Jami kartalar</div><div><strong>${total}</strong></div></div>
                        <div class="flex justify-between mb-2"><div>Yangi</div><div><strong style="color:var(--anki-blue)">${newCount}</strong></div></div>
                        <div class="flex justify-between mb-2"><div>O'rganilmoqda</div><div><strong style="color:var(--anki-red)">${learning}</strong></div></div>
                        <div class="flex justify-between"><div>Review</div><div><strong style="color:var(--anki-green)">${review}</strong></div></div>
                    </div>

                    <div class="bg-[var(--card)] border border-[var(--border)] p-4 rounded-xl">
                        <div class="text-sm text-gray-500 mb-2">SM-2 parametrlar (har karta uchun saqlanadi):</div>
                        <div class="text-xs text-gray-600">Efactor (ef), Repetitions (reps), Interval (kunlarda). Ularni "Browse" orqali tekshirish mumkin.</div>
                    </div>
                </div>
            </div>
        `;
    }
};

/* ======================
   STUDY Controller
   ====================== */
const Study = {
    activeCard: null,
    isAnswerShown: false,

    showAnswer(){
        if(!this.activeCard) return;
        this.isAnswerShown = true;
        document.getElementById('answer-area')?.classList.remove('hidden');
        document.getElementById('btn-show')?.classList.add('hidden');
        const btns = document.getElementById('btns-rate');
        if(btns) btns.classList.remove('hidden');

        const c = this.activeCard;
        if(c.type === 'cloze'){
            const revealed = c.front.replace(/{{c(\d+)::(.*?)(?:::(.*?))?}}/g, (m, idx, ans) => `<span class="cloze-revealed">${Utils.sanitize(ans)}</span>`);
            document.getElementById('card-front-content').innerHTML = revealed;
            document.getElementById('card-back-content').innerHTML = c.back ? Utils.sanitize(c.back) : '<em class="text-gray-400">Cloze karta</em>';
        } else {
            document.getElementById('card-back-content').innerHTML = Utils.sanitize(c.back || '');
        }

        // update small labels on rating buttons to show next intervals (approx)
        // compute preview intervals using SM-2 logic (simulate without committing)
        try {
            const qMap = {1:0,2:3,3:4,4:5};
            const previewEls = document.querySelectorAll('#btns-rate button .text-xs');
            // but in this markup .text-xs is used inside buttons; ensure we update visible text
            const btnsAll = document.querySelectorAll('#btns-rate button');
            btnsAll.forEach((btn, idx) => {
                // idx 0..3 corresponds to rating 1..4
                const rating = idx+1;
                const q = qMap[rating];
                // simulate:
                let ef = (c.ef || 2.5), reps = (c.reps || 0), ivl = (c.interval || 1);
                if(q < 3){ reps = 0; ivl = 1; }
                else {
                    if(reps === 0) ivl = 1;
                    else if(reps === 1) ivl = 6;
                    else ivl = Math.max(1, Math.round(ivl * ef));
                }
                const small = btn.querySelector('.text-xs');
                if(small) small.innerText = ivl + 'd';
            });
        } catch(e){}
    },

    rate(r){
        if(!this.activeCard) return;
        const updated = Scheduler.answer(this.activeCard, r);
        const ix = DB.data.cards.findIndex(x => x.id === updated.id);
        if(ix !== -1) DB.data.cards[ix] = updated;
        DB.save();
        // reload study page for same deck to get next card
        Router.nav('study', updated.deckId);
    }
};

/* ======================
   ACTIONS
   ====================== */
const Actions = {
    createDeck(){
        const name = prompt('Deck nomi kiriting:');
        if(!name || !name.trim()) return;
        DB.addDeck(name.trim());
        UI.toast('Deck yaratildi');
        Router.nav('decks');
    },

    confirmDeleteDeck(id){
        if(!confirm('Deck va uning barcha kartalarini o\'chirmoqchimisiz?')) return;
        DB.deleteDeck(id);
        UI.toast('Deck o\'chirildi');
        Router.nav('decks');
    },

    addCard(){
        const deckEl = document.getElementById('add-deck');
        const typeEl = document.getElementById('add-type');
        const frontEl = document.getElementById('field-front');
        const backEl = document.getElementById('field-back');
        if(!deckEl || !typeEl || !frontEl) return UI.toast('Form topilmadi');

        const deckId = deckEl.value;
        const type = typeEl.value;
        const front = frontEl.innerHTML.trim();
        const back = backEl ? backEl.innerHTML.trim() : '';

        if(!front){ alert('Iltimos old tomonni to\'ldiring.'); return; }
        if(type === 'cloze' && !/{{c\d+::.+?}}/.test(front)){
            alert('Cloze karta uchun kamida bitta {{c1::...}} formatida joy bo\'lishi kerak.');
            return;
        }

        const card = {
            id: Utils.id(),
            deckId,
            front,
            back,
            type,
            due: Date.now(),
            ef: 2.5,
            reps: 0,
            interval: 0,
            state: 'new'
        };
        DB.addCard(card);
        frontEl.innerHTML = ''; backEl && (backEl.innerHTML = '');
        UI.toast('Karta qo\'shildi');
        Router.nav('browse');
    },

    deleteCard(id){
        if(!confirm('Kartani o\'chirilsinmi?')) return;
        DB.deleteCard(id);
        UI.toast('Karta o\'chirildi');
        Router.nav('browse');
    }
};

/* ======================
   UI Utilities (cloze auto-index etc.)
   ====================== */
const UI = {
    toggleAddFields(){
        const type = document.getElementById('add-type')?.value || 'basic';
        const btnCloze = document.getElementById('btn-cloze-insert');
        if(type === 'cloze'){ btnCloze?.classList.remove('hidden'); } else { btnCloze?.classList.add('hidden'); }
    },

    format(cmd){
        document.execCommand(cmd, false, null);
        document.getElementById('field-front')?.focus();
    },

    insertCloze(){
        const field = document.getElementById('field-front');
        if(!field) return;
        // determine next cloze index by scanning existing {{cN::}} in field html
        const html = field.innerHTML || '';
        let max = 0;
        const re = /{{c(\d+)::/g;
        let m;
        while((m = re.exec(html)) !== null){
            const n = parseInt(m[1],10);
            if(!isNaN(n) && n > max) max = n;
        }
        const next = max + 1;
        const sel = window.getSelection();
        if(sel && sel.rangeCount){
            const range = sel.getRangeAt(0);
            if(field.contains(range.commonAncestorContainer)){
                const selectedText = sel.toString() || '';
                const insertText = `{{c${next}::${Utils.sanitize(selectedText)}}}`;
                // insert as text node so HTML tags won't break format (we sanitized)
                const node = document.createElement('span');
                node.innerHTML = insertText;
                range.deleteContents();
                range.insertNode(node);
                range.setStartAfter(node);
                range.collapse(true);
                sel.removeAllRanges();
                sel.addRange(range);
                field.focus();
                return;
            }
        }
        // fallback: append to content
        field.innerHTML += `{{c${next}::}}`;
        field.focus();
    },

    toast(msg='Amal bajarildi'){
        const el = document.getElementById('toast');
        el.textContent = msg;
        el.classList.add('show');
        clearTimeout(el._t);
        el._t = setTimeout(()=> el.classList.remove('show'), 2200);
    }
};

/* ======================
   GLOBAL KEYBOARD SHORTCUTS
   ====================== */
document.addEventListener('keydown', (e) => {
    // Study shortcuts
    if(Router.currentPage === 'study' && Study.activeCard){
        if(e.code === 'Space'){ e.preventDefault(); if(!Study.isAnswerShown) Study.showAnswer(); else Study.rate(3); }
        if(Study.isAnswerShown){
            if(e.key === '1') Study.rate(1);
            if(e.key === '2') Study.rate(2);
            if(e.key === '3') Study.rate(3);
            if(e.key === '4') Study.rate(4);
        }
    }
    // Add shortcuts
    if(Router.currentPage === 'add' && (e.ctrlKey || e.metaKey) && e.key === 'Enter'){ Actions.addCard(); }
    // Formatting shortcuts
    if((e.ctrlKey || e.metaKey) && (e.key === 'b' || e.key === 'i' || e.key === 'u')){
        e.preventDefault();
        if(e.key === 'b') UI.format('bold');
        if(e.key === 'i') UI.format('italic');
        if(e.key === 'u') UI.format('underline');
    }
});

/* ======================
   INIT
   ====================== */
(function init(){
    Theme.init();
    DB.init();
    Router.nav('decks');

    // expose for console debugging if needed
    window.Router = Router;
    window.DB = DB;
    window.Actions = Actions;
    window.Study = Study;
    window.UI = UI;
    window.Scheduler = Scheduler;
})();
</script>

</body>
</html>