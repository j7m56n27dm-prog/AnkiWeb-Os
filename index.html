<!DOCTYPE html>
<html lang="uz" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Anki Pro Ultimate - Cloze+++ & SM-2</title>

    <!-- PWA Manifest (Data URI orqali) -->
    <link rel="manifest" href='data:application/manifest+json,{"name":"Anki Pro Ultimate","short_name":"AnkiPro","start_url":".","display":"standalone","background_color":"#F5F5F7","theme_color":"#007AFF","icons":[{"src":"https://cdn-icons-png.flaticon.com/512/2991/2991148.png","sizes":"192x192","type":"image/png"}]}'>
    <meta name="theme-color" content="#007AFF">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <!-- Kutubxonalar -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        light: { bg: '#F5F5F7', card: '#FFFFFF', border: '#E5E5EA', text: '#1D1D1F' },
                        dark: { bg: '#000000', card: '#1C1C1E', border: '#38383A', text: '#F5F5F7' },
                        anki: { blue: '#007AFF', green: '#34C759', red: '#FF3B30', orange: '#FF9500' }
                    }
                }
            }
        }
    </script>

    <style>
        /* Asosiy va Reset */
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #C1C1C1; border-radius: 3px; }
        .dark ::-webkit-scrollbar-thumb { background: #555; }

        /* Karta Dizayni */
        .card-face {
            min-height: 250px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; padding: 2rem; border-radius: 12px;
            font-size: 1.25rem; line-height: 1.6;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }
        .light .card-face { background: white; border: 1px solid #E5E5EA; }
        .dark .card-face { background: #1C1C1E; border: 1px solid #38383A; }

        /* Cloze Styles */
        .cloze-hidden { 
            color: #007AFF; font-weight: 700; cursor: pointer;
            background: rgba(0,122,255,0.1); padding: 2px 6px; border-radius: 4px;
            border-bottom: 2px dashed #007AFF;
        }
        .cloze-revealed { 
            color: #34C759; font-weight: 700;
            background: rgba(52,199,89,0.15); padding: 2px 6px; border-radius: 4px;
        }

        /* Editor */
        .editor-area {
            min-height: 120px; max-height: 300px; overflow-y: auto;
            border: 1px solid transparent; outline: none; padding: 12px; border-radius: 8px;
        }
        .light .editor-area { background: #FFF; border-color: #D1D1D6; }
        .dark .editor-area { background: #1C1C1E; border-color: #38383A; color: #FFF; }
        .editor-area:focus { border-color: #007AFF; box-shadow: 0 0 0 2px rgba(0,122,255,0.2); }

        /* Context Menu */
        .context-menu {
            position: absolute; z-index: 1000;
            background: white; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            overflow: hidden; min-width: 160px;
        }
        .dark .context-menu { background: #2C2C2E; border: 1px solid #38383A; }
        
        /* Animatsiyalar */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-light-bg text-light-text dark:bg-dark-bg dark:text-dark-text transition-colors duration-300">

    <!-- HEADER -->
    <header class="h-14 bg-white/90 dark:bg-[#1C1C1E]/90 backdrop-blur border-b border-light-border dark:border-dark-border flex items-center justify-between px-4 sticky top-0 z-50">
        <div class="flex items-center gap-4">
            <h1 class="text-lg font-bold tracking-tight"><i class="fa-solid fa-layer-group text-anki-blue mr-2"></i>Anki Pro</h1>
            <!-- Desktop Nav -->
            <nav class="hidden md:flex gap-1 bg-gray-100 dark:bg-[#2C2C2E] p-1 rounded-lg">
                <button onclick="Router.nav('decks')" id="nav-decks" class="px-4 py-1.5 rounded-md text-sm font-medium transition-all">Decks</button>
                <button onclick="Router.nav('add')" id="nav-add" class="px-4 py-1.5 rounded-md text-sm font-medium transition-all">Add</button>
                <button onclick="Router.nav('browse')" id="nav-browse" class="px-4 py-1.5 rounded-md text-sm font-medium transition-all">Browse</button>
                <button onclick="Router.nav('stats')" id="nav-stats" class="px-4 py-1.5 rounded-md text-sm font-medium transition-all">Stats</button>
            </nav>
        </div>
        <div class="flex items-center gap-3">
            <button onclick="Theme.toggle()" class="w-8 h-8 rounded-full flex items-center justify-center hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                <i id="theme-icon" class="fa-solid fa-moon"></i>
            </button>
            <button class="md:hidden text-xl" onclick="document.getElementById('mobile-menu').classList.toggle('hidden')">
                <i class="fa-solid fa-bars"></i>
            </button>
        </div>
    </header>

    <!-- MOBILE MENU -->
    <div id="mobile-menu" class="hidden fixed inset-0 z-40 bg-black/50 md:hidden" onclick="this.classList.add('hidden')">
        <div class="absolute top-14 left-0 w-full bg-white dark:bg-[#1C1C1E] border-b dark:border-[#38383A] shadow-xl p-2 flex flex-col gap-1" onclick="event.stopPropagation()">
            <button onclick="Router.nav('decks'); document.getElementById('mobile-menu').classList.add('hidden')" class="p-3 text-left rounded-lg hover:bg-gray-100 dark:hover:bg-[#2C2C2E] flex items-center gap-3"><i class="fa-solid fa-layer-group w-6"></i> Decks</button>
            <button onclick="Router.nav('add'); document.getElementById('mobile-menu').classList.add('hidden')" class="p-3 text-left rounded-lg hover:bg-gray-100 dark:hover:bg-[#2C2C2E] flex items-center gap-3"><i class="fa-solid fa-plus w-6"></i> Add Card</button>
            <button onclick="Router.nav('browse'); document.getElementById('mobile-menu').classList.add('hidden')" class="p-3 text-left rounded-lg hover:bg-gray-100 dark:hover:bg-[#2C2C2E] flex items-center gap-3"><i class="fa-solid fa-magnifying-glass w-6"></i> Browse</button>
            <button onclick="Router.nav('stats'); document.getElementById('mobile-menu').classList.add('hidden')" class="p-3 text-left rounded-lg hover:bg-gray-100 dark:hover:bg-[#2C2C2E] flex items-center gap-3"><i class="fa-solid fa-chart-pie w-6"></i> Stats</button>
        </div>
    </div>

    <!-- MAIN APP VIEWPORT -->
    <main id="app" class="flex-1 overflow-y-auto p-4 md:p-6 max-w-5xl mx-auto w-full pb-32">
        <!-- Content injects here -->
    </main>

    <!-- TOAST NOTIFICATION -->
    <div id="toast" class="fixed bottom-24 left-1/2 -translate-x-1/2 bg-gray-900 dark:bg-white text-white dark:text-black px-6 py-3 rounded-full shadow-xl text-sm font-semibold opacity-0 pointer-events-none transition-all duration-300 z-50 transform translate-y-4">
        Action Completed
    </div>

    <!-- CONTEXT MENU (Cloze) -->
    <div id="context-menu" class="context-menu hidden">
        <button onclick="Editor.insertCloze()" class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-[#3A3A3C] text-sm flex items-center gap-2">
            <i class="fa-solid fa-brackets-curly text-anki-blue"></i> Cloze (Ctrl+Shift+C)
        </button>
        <button onclick="Editor.insertClozeWithHint()" class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-[#3A3A3C] text-sm flex items-center gap-2">
            <i class="fa-solid fa-comment-dots text-anki-green"></i> Cloze + Hint
        </button>
        <div class="h-px bg-gray-200 dark:bg-gray-700 my-1"></div>
        <button onclick="document.execCommand('bold')" class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-[#3A3A3C] text-sm flex items-center gap-2">
            <i class="fa-solid fa-bold"></i> Bold
        </button>
    </div>

    <!-- STUDY CONTROLS (Fixed Bottom) -->
    <div id="study-controls" class="fixed bottom-0 left-0 w-full bg-white/95 dark:bg-[#1C1C1E]/95 backdrop-blur border-t border-light-border dark:border-dark-border p-4 z-40 hidden">
        <div class="max-w-2xl mx-auto">
            <button id="btn-show-answer" onclick="Study.showAnswer()" class="w-full bg-anki-blue text-white h-12 rounded-xl font-bold text-lg shadow-lg hover:brightness-110 active:scale-95 transition-transform">
                Show Answer (Space)
            </button>
            
            <div id="btns-rate" class="hidden grid grid-cols-4 gap-2">
                <button onclick="Study.rate(0)" class="flex flex-col items-center justify-center p-2 rounded-xl border-2 border-anki-red text-anki-red hover:bg-red-50 dark:hover:bg-red-900/20 active:scale-95 transition-transform">
                    <span class="text-xs font-bold mb-1">Again</span>
                    <span class="text-xs opacity-70" id="lbl-again">1m</span>
                </button>
                <button onclick="Study.rate(1)" class="flex flex-col items-center justify-center p-2 rounded-xl border border-gray-400 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-white/5 active:scale-95 transition-transform">
                    <span class="text-xs font-bold mb-1">Hard</span>
                    <span class="text-xs opacity-70" id="lbl-hard">6m</span>
                </button>
                <button onclick="Study.rate(2)" class="flex flex-col items-center justify-center p-2 rounded-xl border-2 border-anki-green text-anki-green hover:bg-green-50 dark:hover:bg-green-900/20 active:scale-95 transition-transform">
                    <span class="text-xs font-bold mb-1">Good</span>
                    <span class="text-xs opacity-70" id="lbl-good">1d</span>
                </button>
                <button onclick="Study.rate(3)" class="flex flex-col items-center justify-center p-2 rounded-xl border-2 border-anki-blue text-anki-blue hover:bg-blue-50 dark:hover:bg-blue-900/20 active:scale-95 transition-transform">
                    <span class="text-xs font-bold mb-1">Easy</span>
                    <span class="text-xs opacity-70" id="lbl-easy">4d</span>
                </button>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- UTILS ---
        const $ = (sel) => document.querySelector(sel);
        const Utils = {
            id: () => 'id_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 5),
            escape: (s) => s ? s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])) : '',
            toast: (msg) => {
                const t = $('#toast'); t.innerText = msg;
                t.classList.remove('opacity-0', 'translate-y-4'); t.classList.add('opacity-100', 'translate-y-0');
                setTimeout(() => { t.classList.remove('opacity-100', 'translate-y-0'); t.classList.add('opacity-0', 'translate-y-4'); }, 2000);
            }
        };

        // --- DATABASE (LocalStorage) ---
        const DB = {
            data: { decks: [], cards: [], settings: { dark: false } },
            init() {
                const saved = localStorage.getItem('anki_ultimate_db');
                if (saved) {
                    this.data = JSON.parse(saved);
                    // Migration check
                    if (!this.data.cards[0]?.factor) this.migrate();
                } else {
                    this.seed();
                }
                Theme.apply(this.data.settings.dark);
            },
            save() { localStorage.setItem('anki_ultimate_db', JSON.stringify(this.data)); },
            migrate() {
                this.data.cards = this.data.cards.map(c => ({
                    ...c, factor: c.factor || 2500, interval: c.interval || 0,
                    ease: c.ease || 2.5, repetitions: c.repetitions || 0, state: c.state || 'new'
                }));
                this.save();
            },
            seed() {
                const dId = Utils.id();
                this.data.decks = [{ id: dId, name: 'General Knowledge', desc: 'Default deck' }];
                this.data.cards = [
                    { id: Utils.id(), deckId: dId, type: 'cloze', front: 'The capital of {{c1::France}} is {{c2::Paris}}.', back: 'Extra Info: Europe', factor: 2500, interval: 0, repetitions: 0, ease: 2.5, state: 'new', due: Date.now() }
                ];
                this.save();
            },
            getStats(deckId) {
                const cards = deckId ? this.data.cards.filter(c => c.deckId === deckId) : this.data.cards;
                const now = Date.now();
                return {
                    new: cards.filter(c => c.state === 'new').length,
                    learning: cards.filter(c => c.state === 'learning').length,
                    review: cards.filter(c => c.state === 'review' && c.due <= now).length,
                    total: cards.length
                };
            }
        };

        // --- THEME ---
        const Theme = {
            toggle() {
                DB.data.settings.dark = !DB.data.settings.dark;
                DB.save();
                this.apply(DB.data.settings.dark);
            },
            apply(isDark) {
                document.documentElement.classList.toggle('dark', isDark);
                $('#theme-icon').className = isDark ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
                // Update Nav Buttons
                document.querySelectorAll('nav button').forEach(b => {
                    const isActive = b.id === `nav-${Router.current}`;
                    b.className = isActive 
                        ? 'px-4 py-1.5 rounded-md text-sm font-medium bg-white shadow-sm text-black dark:bg-[#505050] dark:text-white transition-all'
                        : 'px-4 py-1.5 rounded-md text-sm font-medium text-gray-500 hover:text-gray-900 dark:text-gray-400 transition-all';
                });
            }
        };

        // --- SM-2 ALGORITHM ---
        const SM2 = {
            calc(card, quality) {
                // quality: 0=Again, 1=Hard, 2=Good, 3=Easy
                const now = Date.now();
                let nextInterval = 1; // days
                let nextFactor = card.factor;

                if (quality === 0) {
                    // Again
                    card.state = 'learning';
                    card.repetitions = 0;
                    card.interval = 0; // < 1 day (1 min)
                    card.due = now + 60000; // 1 min
                } else if (quality === 1) {
                    // Hard
                    card.state = 'learning';
                    card.due = now + 600000; // 10 min
                } else {
                    // Good or Easy
                    if (card.state === 'new' || card.state === 'learning') {
                        card.state = 'review';
                        card.interval = 1; // 1 day graduate
                        card.repetitions = 1;
                    } else {
                        // Review logic
                        if (quality === 3) nextInterval = Math.round(card.interval * (card.ease * 1.3)); // Easy bonus
                        else nextInterval = Math.round(card.interval * card.ease);
                        
                        card.repetitions += 1;
                        
                        // Update E-Factor
                        let newEase = card.ease + (0.1 - (3 - quality) * (0.08 + (3 - quality) * 0.02));
                        if (newEase < 1.3) newEase = 1.3;
                        card.ease = newEase;
                        card.factor = Math.round(newEase * 1000);
                        card.interval = nextInterval;
                    }
                    card.due = now + (card.interval * 86400000);
                }
                return card;
            }
        };

        // --- CLOZE ENGINE ---
        const Cloze = {
            getNextIndex(html) {
                const matches = html.match(/{{c(\d+)::/g);
                if (!matches) return 1;
                const indices = matches.map(m => parseInt(m.match(/\d+/)[0]));
                return Math.max(0, ...indices) + 1;
            },
            render(text, revealIds = []) {
                let i = 0;
                return text.replace(/{{c(\d+)::(.*?)(?:::(.*?))?}}/g, (match, id, content, hint) => {
                    const isRevealed = revealIds.includes(id) || revealIds.includes('all');
                    if (isRevealed) {
                        return `<span class="cloze-revealed">${content}</span>`;
                    } else {
                        const label = hint ? `[${hint}]` : `[...]`;
                        return `<span class="cloze-hidden" onclick="Study.revealCloze('${id}')">${label}</span>`;
                    }
                });
            }
        };

        // --- EDITOR LOGIC ---
        const Editor = {
            insertCloze() { this.wrapSelection(); },
            insertClozeWithHint() {
                const hint = prompt("Hint matni:");
                if(hint !== null) this.wrapSelection(hint);
            },
            wrapSelection(hint = null) {
                const sel = window.getSelection();
                if (!sel.rangeCount) return;
                const range = sel.getRangeAt(0);
                const container = document.getElementById('field-front');
                if (!container.contains(range.commonAncestorContainer)) return;

                const text = sel.toString();
                const idx = Cloze.getNextIndex(container.innerHTML);
                const clozeText = hint 
                    ? `{{c${idx}::${text || '...' }::${hint}}}` 
                    : `{{c${idx}::${text || '...'}}}`;
                
                document.execCommand('insertText', false, clozeText);
                $('#context-menu').classList.add('hidden');
            }
        };

        // --- ROUTER & VIEWS ---
        const Router = {
            current: 'decks',
            nav(page, param) {
                this.current = page;
                Theme.apply(DB.data.settings.dark); // Update nav active state
                $('#study-controls').classList.add('hidden');
                
                const app = $('#app');
                app.innerHTML = ''; // Clear
                
                switch(page) {
                    case 'decks': this.renderDecks(app); break;
                    case 'add': this.renderAdd(app); break;
                    case 'study': this.renderStudy(app, param); break;
                    case 'browse': this.renderBrowse(app); break;
                    case 'edit': this.renderEdit(app, param); break;
                    case 'stats': this.renderStats(app); break;
                }
            },

            renderDecks(root) {
                const decks = DB.data.decks;
                let html = `
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold">Decks</h2>
                        <button onclick="Actions.addDeck()" class="bg-anki-blue text-white px-4 py-2 rounded-lg font-medium shadow hover:brightness-110"><i class="fa-solid fa-plus mr-2"></i>Create</button>
                    </div>
                    <div class="grid gap-3">
                `;
                
                if(decks.length === 0) html += `<div class="text-center text-gray-500 mt-10">No decks found. Create one!</div>`;

                decks.forEach(d => {
                    const stats = DB.getStats(d.id);
                    html += `
                        <div class="bg-light-card dark:bg-dark-card p-4 rounded-xl border border-light-border dark:border-dark-border flex items-center justify-between group cursor-pointer hover:border-anki-blue transition-colors" onclick="Router.nav('study', '${d.id}')">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 rounded-lg bg-blue-100 dark:bg-blue-900/20 text-anki-blue flex items-center justify-center text-xl"><i class="fa-solid fa-book"></i></div>
                                <div>
                                    <div class="font-bold text-lg">${Utils.escape(d.name)}</div>
                                    <div class="text-xs text-gray-500">${stats.total} cards</div>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="text-xs text-right hidden sm:block">
                                    <span class="text-anki-blue font-bold px-2">${stats.new} New</span>
                                    <span class="text-anki-red font-bold px-2">${stats.learning} Lrn</span>
                                    <span class="text-anki-green font-bold px-2">${stats.review} Rev</span>
                                </div>
                                <button onclick="event.stopPropagation(); Actions.deleteDeck('${d.id}')" class="w-8 h-8 rounded-full hover:bg-red-100 text-red-500 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                root.innerHTML = html;
            },

            renderAdd(root) {
                const decks = DB.data.decks.map(d => `<option value="${d.id}">${d.name}</option>`).join('');
                root.innerHTML = `
                    <div class="max-w-2xl mx-auto animate-fade-in">
                        <h2 class="text-2xl font-bold mb-6">Add Card</h2>
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-1 opacity-70">Deck</label>
                                    <select id="add-deck" class="w-full p-2 rounded-lg bg-light-card dark:bg-dark-card border border-light-border dark:border-dark-border outline-none">${decks}</select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1 opacity-70">Type</label>
                                    <select id="add-type" onchange="UI.toggleType()" class="w-full p-2 rounded-lg bg-light-card dark:bg-dark-card border border-light-border dark:border-dark-border outline-none">
                                        <option value="basic">Basic</option>
                                        <option value="cloze">Cloze (Cloze+++)</option>
                                    </select>
                                </div>
                            </div>

                            <div>
                                <div class="flex justify-between mb-1">
                                    <label class="text-sm font-medium opacity-70">Front / Text</label>
                                    <button onclick="Editor.insertCloze()" class="text-xs text-anki-blue font-bold hidden" id="btn-cloze-trigger"><i class="fa-solid fa-brackets-curly"></i> Add Cloze</button>
                                </div>
                                <div id="field-front" contenteditable="true" class="editor-area" oncontextmenu="UI.contextMenu(event)"></div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium mb-1 opacity-70">Back / Extra</label>
                                <div id="field-back" contenteditable="true" class="editor-area"></div>
                            </div>

                            <div class="flex gap-3 pt-4">
                                <button onclick="Actions.addCard(true)" class="flex-1 py-3 border border-anki-blue text-anki-blue rounded-xl font-bold hover:bg-blue-50 dark:hover:bg-blue-900/20">Add & New</button>
                                <button onclick="Actions.addCard(false)" class="flex-1 py-3 bg-anki-blue text-white rounded-xl font-bold hover:brightness-110 shadow-lg">Add Card</button>
                            </div>
                        </div>
                    </div>
                `;
            },

            renderStudy(root, deckId) {
                const now = Date.now();
                const dueCards = DB.data.cards.filter(c => c.deckId === deckId && c.due <= now).sort((a,b) => a.due - b.due);
                
                if (dueCards.length === 0) {
                    root.innerHTML = `
                        <div class="flex flex-col items-center justify-center h-[60vh] text-center animate-fade-in">
                            <div class="w-24 h-24 bg-green-100 dark:bg-green-900/20 text-anki-green rounded-full flex items-center justify-center text-4xl mb-6"><i class="fa-solid fa-check"></i></div>
                            <h2 class="text-2xl font-bold mb-2">Congratulations!</h2>
                            <p class="text-gray-500 mb-6">You have finished this deck for now.</p>
                            <button onclick="Router.nav('decks')" class="bg-gray-200 dark:bg-gray-700 px-6 py-2 rounded-lg font-medium">Back to Decks</button>
                        </div>
                    `;
                    return;
                }

                Study.queue = dueCards;
                Study.currentCard = dueCards[0];
                Study.isRevealed = false;
                
                // Cloze rendering logic
                let frontHtml = Study.currentCard.front;
                if(Study.currentCard.type === 'cloze') {
                    frontHtml = Cloze.render(Study.currentCard.front, []);
                }

                root.innerHTML = `
                    <div class="max-w-2xl mx-auto pt-4 pb-32 animate-fade-in">
                        <div class="flex justify-between items-center mb-4 text-sm text-gray-500">
                            <span><span class="text-anki-blue font-bold">${dueCards.length}</span> cards due</span>
                            <span class="uppercase tracking-wider font-bold text-xs px-2 py-1 rounded bg-gray-200 dark:bg-gray-800">${Study.currentCard.state}</span>
                        </div>
                        
                        <div class="card-face mb-6">
                            <div class="w-full text-left prose dark:prose-invert">
                                ${frontHtml}
                            </div>
                        </div>

                        <div id="answer-area" class="hidden animate-fade-in">
                            <div class="card-face border-t-0 border-anki-blue" style="min-height: auto; padding-top: 0;">
                                <div class="w-full border-t border-gray-200 dark:border-gray-700 my-4"></div>
                                <div class="w-full text-left prose dark:prose-invert">
                                    ${Utils.escape(Study.currentCard.back)}
                                </div>
                                ${Study.currentCard.type === 'cloze' ? `
                                    <div class="mt-4 p-3 bg-gray-50 dark:bg-gray-800 rounded text-left text-sm w-full">
                                        <div class="font-bold mb-1 opacity-70">Full Text:</div>
                                        ${Cloze.render(Study.currentCard.front, ['all'])}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
                $('#study-controls').classList.remove('hidden');
                $('#btn-show-answer').classList.remove('hidden');
                $('#btns-rate').classList.add('hidden');
            },
            
            renderBrowse(root) {
                const cards = DB.data.cards;
                let rows = cards.map(c => `
                    <tr class="border-b border-light-border dark:border-dark-border hover:bg-gray-50 dark:hover:bg-[#2C2C2E] cursor-pointer" onclick="Router.nav('edit', '${c.id}')">
                        <td class="p-3 truncate max-w-[150px]">${Utils.escape(c.front)}</td>
                        <td class="p-3 truncate max-w-[150px] hidden sm:table-cell">${Utils.escape(c.back)}</td>
                        <td class="p-3 text-xs uppercase font-bold ${c.state==='new'?'text-anki-blue':c.state==='learning'?'text-anki-red':'text-anki-green'}">${c.state}</td>
                        <td class="p-3 text-right text-gray-400"><i class="fa-solid fa-chevron-right text-xs"></i></td>
                    </tr>
                `).join('');

                root.innerHTML = `
                    <div class="max-w-4xl mx-auto">
                         <h2 class="text-2xl font-bold mb-6">Browse Cards (${cards.length})</h2>
                         <div class="bg-light-card dark:bg-dark-card rounded-xl border border-light-border dark:border-dark-border overflow-hidden">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-gray-50 dark:bg-[#2C2C2E] border-b border-light-border dark:border-dark-border font-medium text-gray-500">
                                    <tr>
                                        <th class="p-3">Front</th>
                                        <th class="p-3 hidden sm:table-cell">Back</th>
                                        <th class="p-3">State</th>
                                        <th class="p-3"></th>
                                    </tr>
                                </thead>
                                <tbody>${rows}</tbody>
                            </table>
                         </div>
                    </div>
                `;
            },

            renderEdit(root, cardId) {
                const card = DB.data.cards.find(c => c.id === cardId);
                if(!card) return Router.nav('browse');
                
                const decks = DB.data.decks.map(d => `<option value="${d.id}" ${d.id === card.deckId ? 'selected' : ''}>${d.name}</option>`).join('');

                root.innerHTML = `
                    <div class="max-w-2xl mx-auto animate-fade-in pb-20">
                        <h2 class="text-2xl font-bold mb-6">Edit Card</h2>
                        
                        <div class="bg-light-card dark:bg-dark-card p-6 rounded-xl border border-light-border dark:border-dark-border space-y-4 shadow-sm">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-xs font-bold uppercase opacity-60">Deck</label>
                                    <select id="edit-deck" class="w-full mt-1 p-2 rounded bg-gray-50 dark:bg-black border border-light-border dark:border-dark-border">${decks}</select>
                                </div>
                                <div>
                                    <label class="text-xs font-bold uppercase opacity-60">Type</label>
                                    <select id="edit-type" class="w-full mt-1 p-2 rounded bg-gray-50 dark:bg-black border border-light-border dark:border-dark-border">
                                        <option value="basic" ${card.type==='basic'?'selected':''}>Basic</option>
                                        <option value="cloze" ${card.type==='cloze'?'selected':''}>Cloze</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label class="text-xs font-bold uppercase opacity-60">Front</label>
                                <div id="edit-front" contenteditable="true" class="editor-area mt-1">${card.front}</div> <!-- Raw HTML needed for clozes -->
                            </div>
                            
                            <div>
                                <label class="text-xs font-bold uppercase opacity-60">Back</label>
                                <div id="edit-back" contenteditable="true" class="editor-area mt-1">${card.back}</div>
                            </div>

                            <div class="border-t dark:border-gray-700 pt-4 mt-4">
                                <h3 class="font-bold mb-3 text-anki-blue">SM-2 Parameters (Manual)</h3>
                                <div class="grid grid-cols-3 gap-3 text-sm">
                                    <div>
                                        <label>Interval (days)</label>
                                        <input type="number" id="edit-interval" value="${card.interval}" class="w-full p-2 rounded bg-gray-50 dark:bg-black border dark:border-gray-700">
                                    </div>
                                    <div>
                                        <label>Ease Factor</label>
                                        <input type="number" step="0.1" id="edit-ease" value="${card.ease}" class="w-full p-2 rounded bg-gray-50 dark:bg-black border dark:border-gray-700">
                                    </div>
                                    <div>
                                        <label>Repetitions</label>
                                        <input type="number" id="edit-reps" value="${card.repetitions}" class="w-full p-2 rounded bg-gray-50 dark:bg-black border dark:border-gray-700">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="flex justify-between mt-6">
                            <button onclick="Actions.deleteCard('${card.id}')" class="text-red-500 font-medium px-4">Delete Card</button>
                            <div class="flex gap-3">
                                <button onclick="Router.nav('browse')" class="px-6 py-2 rounded-lg font-medium hover:bg-gray-200 dark:hover:bg-gray-800">Cancel</button>
                                <button onclick="Actions.saveCard('${card.id}')" class="px-6 py-2 bg-anki-blue text-white rounded-lg font-bold hover:brightness-110">Save Changes</button>
                            </div>
                        </div>
                    </div>
                `;
            },

            renderStats(root) {
                const total = DB.data.cards.length;
                const counts = {
                    new: DB.data.cards.filter(c => c.state === 'new').length,
                    lrn: DB.data.cards.filter(c => c.state === 'learning').length,
                    rev: DB.data.cards.filter(c => c.state === 'review').length
                };

                root.innerHTML = `
                    <div class="max-w-4xl mx-auto">
                        <h2 class="text-2xl font-bold mb-6">Statistics</h2>
                        <div class="grid md:grid-cols-2 gap-6">
                            <div class="bg-light-card dark:bg-dark-card p-6 rounded-xl border border-light-border dark:border-dark-border">
                                <canvas id="chart-pie"></canvas>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-blue-100 dark:bg-blue-900/20 p-4 rounded-xl text-center">
                                    <div class="text-2xl font-bold text-anki-blue">${counts.new}</div>
                                    <div class="text-sm opacity-70">New Cards</div>
                                </div>
                                <div class="bg-red-100 dark:bg-red-900/20 p-4 rounded-xl text-center">
                                    <div class="text-2xl font-bold text-anki-red">${counts.lrn}</div>
                                    <div class="text-sm opacity-70">Learning</div>
                                </div>
                                <div class="bg-green-100 dark:bg-green-900/20 p-4 rounded-xl text-center">
                                    <div class="text-2xl font-bold text-anki-green">${counts.rev}</div>
                                    <div class="text-sm opacity-70">Review</div>
                                </div>
                                <div class="bg-gray-100 dark:bg-gray-800 p-4 rounded-xl text-center">
                                    <div class="text-2xl font-bold">${total}</div>
                                    <div class="text-sm opacity-70">Total Cards</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                new Chart(document.getElementById('chart-pie'), {
                    type: 'doughnut',
                    data: {
                        labels: ['New', 'Learning', 'Review'],
                        datasets: [{
                            data: [counts.new, counts.lrn, counts.rev],
                            backgroundColor: ['#007AFF', '#FF3B30', '#34C759'],
                            borderWidth: 0
                        }]
                    },
                    options: { plugins: { legend: { position: 'bottom' } } }
                });
            }
        };

        // --- ACTIONS ---
        const Actions = {
            addDeck() {
                const name = prompt("Yangi koloda nomi:");
                if (name) {
                    DB.data.decks.push({ id: Utils.id(), name, desc: '' });
                    DB.save();
                    Router.nav('decks');
                }
            },
            deleteDeck(id) {
                if(confirm("Haqiqatan ham o'chirmoqchimisiz? Barcha kartalar o'chib ketadi.")) {
                    DB.data.decks = DB.data.decks.filter(d => d.id !== id);
                    DB.data.cards = DB.data.cards.filter(c => c.deckId !== id);
                    DB.save();
                    Router.nav('decks');
                }
            },
            addCard(keepOpen) {
                const front = $('#field-front').innerHTML; // Keep HTML for cloze
                if (!front.trim()) return alert("Front bo'sh bo'lmasligi kerak");
                
                const card = {
                    id: Utils.id(),
                    deckId: $('#add-deck').value,
                    type: $('#add-type').value,
                    front: front,
                    back: $('#field-back').innerHTML,
                    factor: 2500, interval: 0, repetitions: 0, ease: 2.5, state: 'new', due: Date.now()
                };
                DB.data.cards.push(card);
                DB.save();
                Utils.toast("Karta qo'shildi!");
                
                if (keepOpen) {
                    $('#field-front').innerHTML = '';
                    $('#field-back').innerHTML = '';
                    $('#field-front').focus();
                } else {
                    Router.nav('decks');
                }
            },
            saveCard(id) {
                const c = DB.data.cards.find(c => c.id === id);
                if (c) {
                    c.deckId = $('#edit-deck').value;
                    c.type = $('#edit-type').value;
                    c.front = $('#edit-front').innerHTML;
                    c.back = $('#edit-back').innerHTML;
                    // Manual SM-2 overrides
                    c.interval = parseFloat($('#edit-interval').value);
                    c.ease = parseFloat($('#edit-ease').value);
                    c.repetitions = parseInt($('#edit-reps').value);
                    
                    DB.save();
                    Utils.toast("Saqlandi");
                    Router.nav('browse');
                }
            },
            deleteCard(id) {
                if(confirm("O'chirilsinmi?")) {
                    DB.data.cards = DB.data.cards.filter(c => c.id !== id);
                    DB.save();
                    Router.nav('browse');
                }
            }
        };

        // --- STUDY LOGIC ---
        const Study = {
            queue: [],
            currentCard: null,
            isRevealed: false,
            
            revealCloze(id) {
                // Find specific cloze element and reveal it
                const els = document.querySelectorAll('.cloze-hidden');
                els.forEach(el => {
                    if (el.textContent === `[...]` || el.textContent.startsWith('[')) { 
                        // Simplified check - in real app match IDs better
                        // Here we just reveal everything on main answer show, 
                        // but if user clicks specific one, we could toggle class.
                        // For this implementation, clicking reveals ALL (Anki default style) 
                        // or we could implement specific ID matching.
                    }
                });
                // Current implementation: Click reveals all or show answer reveals all
                // To support individual reveal, we need to map DOM elements to IDs.
                // Since innerHTML re-renders, simpler to just show answer for now.
                this.showAnswer();
            },
            showAnswer() {
                if(this.isRevealed) return;
                this.isRevealed = true;
                $('#answer-area').classList.remove('hidden');
                $('#btn-show-answer').classList.add('hidden');
                $('#btns-rate').classList.remove('hidden');
                $('#btns-rate').classList.add('grid');
                
                // Reveal all clozes in front
                const frontContainer = document.querySelector('.card-face .prose');
                if (this.currentCard.type === 'cloze') {
                     frontContainer.innerHTML = Cloze.render(this.currentCard.front, ['all']);
                }
            },
            rate(quality) {
                const updated = SM2.calc(this.currentCard, quality);
                const idx = DB.data.cards.findIndex(c => c.id === updated.id);
                DB.data.cards[idx] = updated;
                DB.save();
                
                // Next card
                const nextQueue = this.queue.slice(1);
                if (nextQueue.length > 0) {
                    this.queue = nextQueue;
                    this.currentCard = nextQueue[0];
                    Router.renderStudy($('#app'), this.currentCard.deckId);
                } else {
                    Router.renderStudy($('#app'), this.currentCard.deckId); // Will show "Congratulations"
                }
            }
        };

        // --- UI HANDLERS ---
        const UI = {
            toggleType() {
                const type = $('#add-type').value;
                if(type === 'cloze') $('#btn-cloze-trigger').classList.remove('hidden');
                else $('#btn-cloze-trigger').classList.add('hidden');
            },
            contextMenu(e) {
                e.preventDefault();
                const menu = $('#context-menu');
                menu.style.left = e.pageX + 'px';
                menu.style.top = e.pageY + 'px';
                menu.classList.remove('hidden');
                
                const close = () => {
                    menu.classList.add('hidden');
                    document.removeEventListener('click', close);
                };
                setTimeout(() => document.addEventListener('click', close), 10);
            }
        };

        // --- INIT & EVENTS ---
        window.addEventListener('load', () => {
            DB.init();
            Router.nav('decks');
            
            // Register Service Worker for PWA
            if ('serviceWorker' in navigator) {
                const swCode = `
                    self.addEventListener('install', e => e.waitUntil(caches.open('anki-v1').then(c => c.addAll(['/']))));
                    self.addEventListener('fetch', e => e.respondWith(caches.match(e.request).then(r => r || fetch(e.request))));
                `;
                const blob = new Blob([swCode], {type: 'application/javascript'});
                navigator.serviceWorker.register(URL.createObjectURL(blob));
            }
        });

        // Keyboard Shortcuts
        document.addEventListener('keydown', e => {
            if (Router.current === 'study') {
                if (e.code === 'Space') {
                    e.preventDefault();
                    if (!Study.isRevealed) Study.showAnswer();
                    else Study.rate(2); // Default Good
                }
                if (Study.isRevealed) {
                    if (e.key === '1') Study.rate(0);
                    if (e.key === '2') Study.rate(1);
                    if (e.key === '3') Study.rate(2);
                    if (e.key === '4') Study.rate(3);
                }
            }
            if (e.ctrlKey && e.shiftKey && e.code === 'KeyC') {
                e.preventDefault();
                Editor.insertCloze();
            }
        });

    </script>
</body>
</html>
