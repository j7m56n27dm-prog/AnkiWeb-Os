<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Anki Pro - Ultimate</title>

    <!-- PWA Manifest -->
    <meta name="theme-color" content="#007AFF">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="data:application/manifest+json,%7B%22name%22%3A%22Anki%20Pro%22%2C%22short_name%22%3A%22AnkiPro%22%2C%22start_url%22%3A%22.%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%23F5F5F7%22%2C%22theme_color%22%3A%22%23007AFF%22%2C%22icons%22%3A%5B%5D%7D">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Chart.js for Stats -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        light: { bg: '#F5F5F7', card: '#FFFFFF', border: '#D1D1D6', text: '#1D1D1F' },
                        dark: { bg: '#1C1C1E', card: '#2C2C2E', border: '#3A3A3C', text: '#F5F5F7' },
                        anki: { blue: '#007AFF', green: '#34C759', red: '#FF3B30', orange: '#FF9500', gray: '#8E8E93' }
                    },
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', 'sans-serif']
                    }
                }
            }
        }
    </script>

    <style>
        * { -webkit-tap-highlight-color: transparent; }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
        }

        @media (display-mode: standalone) { body { height: 100vh; } }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #C1C1C1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #555; }

        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(5px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }

        .anki-table { width: 100%; border-collapse: separate; border-spacing: 0; }
        .anki-table th { text-align: left; font-size: 12px; padding: 10px 16px; border-bottom: 1px solid; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .anki-table td { padding: 14px 16px; font-size: 14px; border-bottom: 1px solid; transition: background 0.2s; }

        .light .anki-table th { color: #86868b; border-color: #D1D1D6; background: #F5F5F7; }
        .light .anki-table td { border-color: #E5E5EA; color: #1D1D1F; background: white; }
        .light .anki-table tr:hover td { background: #F2F2F7; }

        .dark .anki-table th { color: #98989D; border-color: #38383A; background: #1C1C1E; }
        .dark .anki-table td { border-color: #38383A; color: #F5F5F7; background: #2C2C2E; }
        .dark .anki-table tr:hover td { background: #3A3A3C; }

        .card-display {
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border-radius: 12px;
            padding: 30px;
            min-height: 280px;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            text-align: center; 
            font-size: 20px; 
            line-height: 1.5;
            border: 1px solid; 
            transition: all 0.3s;
            word-break: break-word;
        }

        .light .card-display { background: white; border-color: #E5E5EA; }
        .dark .card-display { background: #2C2C2E; border-color: #3A3A3C; }

        .editor-field {
            min-height: 100px; 
            padding: 12px; 
            outline: none; 
            border-radius: 8px; 
            border: 1px solid;
            font-size: 16px; 
            line-height: 1.5; 
            transition: border 0.2s;
            overflow-y: auto;
        }

        .light .editor-field { background: white; border-color: #D1D1D6; }
        .dark .editor-field { background: #1C1C1E; border-color: #3A3A3C; color: white; }
        .editor-field:focus { border-color: #007AFF; outline: 2px solid rgba(0,122,255,0.2); }

        .cloze-hidden { 
            color: #007AFF; 
            font-weight: 700; 
            background: rgba(0,122,255,0.1); 
            padding: 2px 6px; 
            border-radius: 4px; 
            cursor: pointer; 
            border-bottom: 2px dashed currentColor;
        }

        .cloze-revealed { 
            color: #34C759; 
            font-weight: 700; 
            background: rgba(52,199,89,0.1); 
            padding: 2px 6px;
            border-radius: 4px;
        }

        .dark .cloze-hidden { color: #409CFF; background: rgba(64,156,255,0.2); }
        .dark .cloze-revealed { color: #32D74B; background: rgba(50,215,75,0.2); }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .light .modal-content { background: white; }
        .dark .modal-content { background: #2C2C2E; }

        .context-menu {
            position: fixed;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 180px;
            overflow: hidden;
        }

        .dark .context-menu { background: #2C2C2E; border: 1px solid #3A3A3C; }

        .sm2-field {
            width: 100%;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid;
            font-size: 14px;
        }

        .light .sm2-field { background: white; border-color: #D1D1D6; color: #1D1D1F; }
        .dark .sm2-field { background: #1C1C1E; border-color: #3A3A3C; color: #F5F5F7; }

        @media (max-width: 640px) {
            .card-display { padding: 20px; min-height: 200px; font-size: 18px; }
        }
    </style>
</head>
<body class="bg-light-bg text-light-text dark:bg-dark-bg dark:text-dark-text transition-colors duration-300">

    <!-- HEADER -->
    <header class="h-14 bg-white/80 dark:bg-[#2C2C2E]/90 backdrop-blur-md border-b border-light-border dark:border-dark-border flex items-center px-4 md:px-6 justify-between shrink-0 sticky top-0 z-50">
        <div class="flex items-center gap-4 md:gap-6">
            <h1 class="font-bold text-base md:text-lg tracking-tight">
                <i class="fa-solid fa-layer-group text-anki-blue mr-2"></i>Anki Pro
            </h1>
            <nav class="hidden md:flex gap-1 bg-gray-100 dark:bg-[#3A3A3C] p-1 rounded-lg">
                <button onclick="Router.nav('decks')" id="nav-decks" class="nav-btn px-4 py-1.5 rounded-md text-sm font-medium transition-all">Decks</button>
                <button onclick="Router.nav('add')" id="nav-add" class="nav-btn px-4 py-1.5 rounded-md text-sm font-medium transition-all">Add</button>
                <button onclick="Router.nav('browse')" id="nav-browse" class="nav-btn px-4 py-1.5 rounded-md text-sm font-medium transition-all">Browse</button>
                <button onclick="Router.nav('study')" id="nav-study" class="nav-btn px-4 py-1.5 rounded-md text-sm font-medium transition-all">Study</button>
                <button onclick="Router.nav('stats')" id="nav-stats" class="nav-btn px-4 py-1.5 rounded-md text-sm font-medium transition-all">Stats</button>
            </nav>
        </div>

        <div class="flex items-center gap-3">
            <button class="md:hidden text-xl" onclick="UI.toggleMobileMenu()">
                <i class="fa-solid fa-bars"></i>
            </button>
            <button onclick="Theme.toggle()" class="w-8 h-8 rounded-full flex items-center justify-center hover:bg-gray-200 dark:hover:bg-white/10 transition-colors">
                <i id="theme-icon" class="fa-solid fa-moon"></i>
            </button>
        </div>
    </header>

    <!-- MOBILE MENU -->
    <div id="mobile-menu" class="fixed inset-0 bg-black/50 z-40 hidden md:hidden" onclick="UI.toggleMobileMenu()">
        <div class="absolute top-14 left-0 w-full bg-white dark:bg-[#2C2C2E] border-b border-light-border dark:border-dark-border p-4 flex flex-col gap-1 shadow-xl" onclick="event.stopPropagation()">
            <button onclick="Router.nav('decks'); UI.toggleMobileMenu()" class="p-3 text-left font-medium rounded-lg hover:bg-gray-100 dark:hover:bg-white/5 flex items-center gap-3">
                <i class="fa-solid fa-layer-group w-5"></i> Decks
            </button>
            <button onclick="Router.nav('add'); UI.toggleMobileMenu()" class="p-3 text-left font-medium rounded-lg hover:bg-gray-100 dark:hover:bg-white/5 flex items-center gap-3">
                <i class="fa-solid fa-plus w-5"></i> Add Card
            </button>
            <button onclick="Router.nav('browse'); UI.toggleMobileMenu()" class="p-3 text-left font-medium rounded-lg hover:bg-gray-100 dark:hover:bg-white/5 flex items-center gap-3">
                <i class="fa-solid fa-magnifying-glass w-5"></i> Browse
            </button>
            <button onclick="Router.nav('study'); UI.toggleMobileMenu()" class="p-3 text-left font-medium rounded-lg hover:bg-gray-100 dark:hover:bg-white/5 flex items-center gap-3">
                <i class="fa-solid fa-graduation-cap w-5"></i> Study
            </button>
            <button onclick="Router.nav('stats'); UI.toggleMobileMenu()" class="p-3 text-left font-medium rounded-lg hover:bg-gray-100 dark:hover:bg-white/5 flex items-center gap-3">
                <i class="fa-solid fa-chart-bar w-5"></i> Statistics
            </button>
        </div>
    </div>

    <!-- MAIN VIEWPORT -->
    <main id="app-viewport" class="flex-1 overflow-y-auto overflow-x-hidden flex flex-col items-center relative w-full pb-20 md:pb-8"></main>

    <!-- TOAST -->
    <div id="toast" class="fixed bottom-20 md:bottom-10 left-1/2 transform -translate-x-1/2 bg-gray-900 dark:bg-white text-white dark:text-black px-5 py-3 rounded-full shadow-lg text-sm font-semibold opacity-0 pointer-events-none transition-all duration-300 z-50 flex items-center gap-2">
        <i class="fa-solid fa-check"></i>
        <span id="toast-text">Action Completed</span>
    </div>

    <!-- CONTEXT MENU -->
    <div id="context-menu" class="context-menu hidden">
        <button onclick="Cloze.insertClozeWithSelection()" class="w-full text-left px-4 py-3 hover:bg-gray-100 dark:hover:bg-white/5 text-sm font-medium flex items-center gap-3">
            <i class="fa-solid fa-eye-slash text-anki-blue"></i>
            <span>Create Cloze (Ctrl+Shift+C)</span>
        </button>
        <button onclick="Cloze.insertClozeWithHint()" class="w-full text-left px-4 py-3 hover:bg-gray-100 dark:hover:bg-white/5 text-sm font-medium flex items-center gap-3">
            <i class="fa-solid fa-comment-dots text-anki-green"></i>
            <span>Cloze with Hint</span>
        </button>
        <div class="h-px bg-gray-200 dark:bg-gray-700"></div>
        <button onclick="UI.formatText('bold')" class="w-full text-left px-4 py-3 hover:bg-gray-100 dark:hover:bg-white/5 text-sm font-medium flex items-center gap-3">
            <i class="fa-solid fa-bold"></i> Bold (Ctrl+B)
        </button>
        <button onclick="UI.formatText('italic')" class="w-full text-left px-4 py-3 hover:bg-gray-100 dark:hover:bg-white/5 text-sm font-medium flex items-center gap-3">
            <i class="fa-solid fa-italic"></i> Italic (Ctrl+I)
        </button>
    </div>

    <!-- EDIT MODAL -->
    <div id="edit-modal" class="modal-overlay hidden">
        <div class="modal-content p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold">Edit Card</h3>
                <button onclick="UI.closeEditModal()" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>
            <div id="edit-modal-content"></div>
        </div>
    </div>

    <script>
        // ========== UTILITIES ==========
        const Utils = {
            id: () => 'id_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
            escapeHtml: (text) => {
                if (!text) return '';
                const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
                return String(text).replace(/[&<>"']/g, m => map[m]);
            },
            formatInterval: (days) => {
                if (days < 1) return '< 1d';
                if (days < 30) return Math.round(days) + 'd';
                if (days < 365) return Math.round(days / 30) + 'mo';
                return (days / 365).toFixed(1) + 'y';
            }
        };

        // ========== THEME ==========
        const Theme = {
            init() {
                const saved = localStorage.getItem('anki_theme');
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                if (saved === 'dark' || (!saved && prefersDark)) this.enableDark();
                else this.enableLight();
            },
            enableDark() {
                document.documentElement.classList.add('dark');
                document.getElementById('theme-icon').className = 'fa-solid fa-sun';
            },
            enableLight() {
                document.documentElement.classList.remove('dark');
                document.getElementById('theme-icon').className = 'fa-solid fa-moon';
            },
            toggle() {
                const isDark = document.documentElement.classList.contains('dark');
                if (isDark) { this.enableLight(); localStorage.setItem('anki_theme', 'light'); }
                else { this.enableDark(); localStorage.setItem('anki_theme', 'dark'); }
                if (Router.currentPage === 'stats') Stats.renderChart();
            },
            isDark() { return document.documentElement.classList.contains('dark'); }
        };

        // ========== CLOZE+++ ==========
        const Cloze = {
            getNextIndex(text) {
                const matches = text.match(/\{\{c(\d+)::/g) || [];
                const indices = matches.map(m => parseInt(m.match(/\d+/)[0]));
                if (indices.length === 0) return 1;
                indices.sort((a, b) => a - b);
                for (let i = 0; i < indices.length; i++) {
                    if (indices[i] !== i + 1) return i + 1;
                }
                return indices.length + 1;
            },
            insertClozeWithSelection() {
                const field = document.activeElement;
                if (!field || !field.classList.contains('editor-field')) {
                    UI.hideContextMenu();
                    return;
                }
                const selection = window.getSelection();
                const selectedText = selection.toString();
                const nextIndex = this.getNextIndex(field.innerText || field.textContent);

                if (!selectedText) {
                    document.execCommand('insertText', false, '{{c' + nextIndex + '::}}');
                } else {
                    document.execCommand('insertText', false, '{{c' + nextIndex + '::' + selectedText + '}}');
                }
                UI.hideContextMenu();
                field.focus();
            },
            insertClozeWithHint() {
                const hint = prompt('Enter hint (optional):');
                if (hint === null) return;
                const field = document.activeElement;
                if (!field || !field.classList.contains('editor-field')) {
                    UI.hideContextMenu();
                    return;
                }
                const selection = window.getSelection();
                const selectedText = selection.toString() || 'text';
                const nextIndex = this.getNextIndex(field.innerText || field.textContent);
                const clozeText = hint ? '{{c' + nextIndex + '::' + selectedText + '::' + hint + '}}' : '{{c' + nextIndex + '::' + selectedText + '}}';
                document.execCommand('insertText', false, clozeText);
                UI.hideContextMenu();
                field.focus();
            },
            renderForStudy(text, revealAll = false) {
                if (!text || !text.includes('{{c')) return Utils.escapeHtml(text);
                return text.replace(/\{\{c(\d+)::(.*?)(?:::(.*?))?\}\}/g, (match, clozeNum, clozeText, hint) => {
                    if (revealAll) {
                        return '<span class="cloze-revealed">' + Utils.escapeHtml(clozeText) + '</span>';
                    } else {
                        const display = hint ? '[' + Utils.escapeHtml(hint) + ']' : '[...]';
                        return '<span class="cloze-hidden" data-text="' + Utils.escapeHtml(clozeText) + '" onclick="Study.revealCloze(this)">' + display + '</span>';
                    }
                });
            },
            renderForPreview(text) {
                return this.renderForStudy(text, false);
            },
            hasCloze(text) {
                return text && text.includes('{{c');
            }
        };

        // ========== DATABASE ==========
        const DB = {
            key: 'anki_pro_v3',
            data: { decks: [], cards: [], version: 3 },
            init() {
                try {
                    const loaded = localStorage.getItem(this.key);
                    if (loaded) {
                        this.data = JSON.parse(loaded);
                        this.migrate();
                    } else {
                        this.seed();
                    }
                } catch (e) {
                    console.error('DB error:', e);
                    this.seed();
                }
                this.save();
            },
            migrate() {
                this.data.cards = this.data.cards.map(card => ({
                    ...card,
                    ease: card.ease || 2.5,
                    interval: card.interval || 0,
                    repetitions: card.repetitions || 0,
                    state: card.state || 'new',
                    due: card.due || Date.now(),
                    reviews: card.reviews || 0
                }));
            },
            save() {
                try { localStorage.setItem(this.key, JSON.stringify(this.data)); }
                catch (e) { console.error('Save failed:', e); }
            },
            seed() {
                this.data = {
                    decks: [
                        { id: 'd1', name: 'General', desc: 'General knowledge', createdAt: Date.now() },
                        { id: 'd2', name: 'Programming', desc: 'Code concepts', createdAt: Date.now() }
                    ],
                    cards: [
                        { id: 'c1', deckId: 'd1', front: 'The capital of France is {{c1::Paris}}.', back: 'Paris is the City of Light.', type: 'cloze', ease: 2.5, interval: 7, repetitions: 3, state: 'review', due: Date.now(), createdAt: Date.now(), lastReview: Date.now(), reviews: 5 },
                        { id: 'c2', deckId: 'd2', front: '{{c1::JavaScript}} is a {{c2::programming language}} for {{c3::web development::where}}.', back: 'JS works client and server side.', type: 'cloze', ease: 2.2, interval: 1, repetitions: 1, state: 'learning', due: Date.now(), createdAt: Date.now(), lastReview: Date.now(), reviews: 2 },
                        { id: 'c3', deckId: 'd1', front: 'Hello in Spanish', back: 'Hola', type: 'basic', ease: 2.6, interval: 30, repetitions: 5, state: 'review', due: Date.now(), createdAt: Date.now(), lastReview: Date.now(), reviews: 8 }
                    ],
                    version: 3
                };
            },
            addDeck(name, desc = '') {
                const deck = { id: Utils.id(), name: name.trim(), desc: desc.trim(), createdAt: Date.now() };
                this.data.decks.push(deck);
                this.save();
                return deck;
            },
            updateDeck(id, updates) {
                const deck = this.data.decks.find(d => d.id === id);
                if (deck) Object.assign(deck, updates);
                this.save();
                return deck;
            },
            deleteDeck(id) {
                this.data.decks = this.data.decks.filter(d => d.id !== id);
                this.data.cards = this.data.cards.filter(c => c.deckId !== id);
                this.save();
            },
            addCard(data) {
                const now = Date.now();
                const type = Cloze.hasCloze(data.front) ? 'cloze' : 'basic';
                const card = {
                    id: Utils.id(), deckId: data.deckId, front: data.front.trim(), back: data.back.trim(),
                    type, ease: 2.5, interval: 0, repetitions: 0, state: 'new',
                    due: now, createdAt: now, lastReview: now, reviews: 0
                };
                this.data.cards.push(card);
                this.save();
                return card;
            },
            updateCard(card) {
                const idx = this.data.cards.findIndex(c => c.id === card.id);
                if (idx !== -1) this.data.cards[idx] = card;
                this.save();
            },
            deleteCard(id) {
                this.data.cards = this.data.cards.filter(c => c.id !== id);
                this.save();
            },
            getCardsByDeck(deckId) {
                return this.data.cards.filter(c => c.deckId === deckId);
            },
            getDueCards(deckId = null) {
                const now = Date.now();
                let cards = deckId ? this.data.cards.filter(c => c.deckId === deckId) : this.data.cards;
                return cards.filter(c => c.due <= now).sort((a, b) => {
                    const order = { new: 0, learning: 1, review: 2 };
                    return (order[a.state] || 0) - (order[b.state] || 0);
                });
            },
            getCounts(deckId = null) {
                const now = Date.now();
                const cards = deckId ? this.data.cards.filter(c => c.deckId === deckId) : this.data.cards;
                return {
                    new: cards.filter(c => c.state === 'new').length,
                    learning: cards.filter(c => c.state === 'learning').length,
                    review: cards.filter(c => c.state === 'review' && c.due <= now).length,
                    total: cards.length
                };
            },
            getDeckById(id) { return this.data.decks.find(d => d.id === id); }
        };

        // ========== SM-2 SCHEDULER ==========
        const Scheduler = {
            answer(card, quality) {
                // quality: 0=Again, 1=Hard, 2=Good, 3=Easy
                const now = Date.now();
                const day = 86400000;
                card.reviews = (card.reviews || 0) + 1;
                card.lastReview = now;

                if (quality === 0) { // Again
                    card.state = 'learning';
                    card.repetitions = 0;
                    card.interval = 0.00694; // ~10 min in days
                    card.ease = Math.max(1.3, card.ease - 0.2);
                } else if (quality === 1) { // Hard
                    card.state = 'learning';
                    card.interval = Math.max(1, card.interval * 1.2);
                    card.ease = Math.max(1.3, card.ease - 0.15);
                } else if (quality === 2) { // Good
                    if (card.state === 'new' || card.state === 'learning') {
                        card.state = 'review';
                        card.repetitions = 1;
                        card.interval = 1;
                    } else {
                        card.repetitions++;
                        card.interval = Math.round(card.interval * card.ease);
                    }
                } else if (quality === 3) { // Easy
                    card.state = 'review';
                    card.repetitions++;
                    if (card.interval < 1) card.interval = 1;
                    card.interval = Math.round(card.interval * card.ease * 1.3);
                    card.ease = Math.min(2.5, card.ease + 0.15);
                }

                card.interval = Math.max(0.00694, card.interval);
                card.due = now + (card.interval * day);
                return card;
            },
            getIntervalText(card, quality) {
                let interval = card.interval || 0;
                if (quality === 0) interval = 0.00694;
                else if (quality === 1) interval = Math.max(1, interval * 1.2);
                else if (quality === 2) interval = card.state === 'new' ? 1 : Math.max(1, Math.round(interval * card.ease));
                else if (quality === 3) interval = Math.max(1, Math.round((interval || 1) * card.ease * 1.3));
                return Utils.formatInterval(interval);
            }
        };

        // ========== UI ==========
        const UI = {
            toast(msg) {
                const t = document.getElementById('toast');
                document.getElementById('toast-text').textContent = msg;
                t.classList.remove('opacity-0', 'pointer-events-none');
                t.classList.add('opacity-100');
                setTimeout(() => {
                    t.classList.remove('opacity-100');
                    t.classList.add('opacity-0', 'pointer-events-none');
                }, 2500);
            },
            toggleMobileMenu() {
                document.getElementById('mobile-menu').classList.toggle('hidden');
            },
            showContextMenu(e) {
                e.preventDefault();
                const menu = document.getElementById('context-menu');
                menu.style.left = Math.min(e.clientX, window.innerWidth - 200) + 'px';
                menu.style.top = Math.min(e.clientY, window.innerHeight - 200) + 'px';
                menu.classList.remove('hidden');
            },
            hideContextMenu() {
                document.getElementById('context-menu').classList.add('hidden');
            },
            formatText(cmd) {
                document.execCommand(cmd, false, null);
                this.hideContextMenu();
            },
            openEditModal(cardId) {
                const card = DB.data.cards.find(c => c.id === cardId);
                if (!card) return;
                const content = document.getElementById('edit-modal-content');
                content.innerHTML = \`
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Front</label>
                            <div id="edit-front" class="editor-field" contenteditable="true">\${card.front}</div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Back</label>
                            <div id="edit-back" class="editor-field" contenteditable="true">\${card.back}</div>
                        </div>
                        <div class="border-t pt-4 mt-4">
                            <h4 class="font-semibold mb-3">SM-2 Parameters</h4>
                            <div class="grid grid-cols-3 gap-3">
                                <div>
                                    <label class="block text-xs text-gray-500 mb-1">Ease Factor</label>
                                    <input type="number" step="0.1" min="1.3" max="2.5" id="edit-ease" class="sm2-field" value="\${card.ease.toFixed(2)}">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-500 mb-1">Repetitions</label>
                                    <input type="number" min="0" id="edit-reps" class="sm2-field" value="\${card.repetitions}">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-500 mb-1">Interval (days)</label>
                                    <input type="number" step="0.1" min="0" id="edit-interval" class="sm2-field" value="\${card.interval.toFixed(1)}">
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-2 pt-2">
                            <button onclick="UI.saveEditModal('\${card.id}')" class="flex-1 bg-anki-blue text-white py-2 rounded-lg font-medium hover:bg-blue-600">Save</button>
                            <button onclick="UI.closeEditModal()" class="flex-1 bg-gray-200 dark:bg-gray-700 py-2 rounded-lg font-medium hover:bg-gray-300 dark:hover:bg-gray-600">Cancel</button>
                        </div>
                    </div>
                \`;
                document.getElementById('edit-modal').classList.remove('hidden');
            },
            saveEditModal(cardId) {
                const card = DB.data.cards.find(c => c.id === cardId);
                if (!card) return;
                card.front = document.getElementById('edit-front').innerText.trim();
                card.back = document.getElementById('edit-back').innerText.trim();
                card.type = Cloze.hasCloze(card.front) ? 'cloze' : 'basic';
                card.ease = parseFloat(document.getElementById('edit-ease').value) || 2.5;
                card.repetitions = parseInt(document.getElementById('edit-reps').value) || 0;
                card.interval = parseFloat(document.getElementById('edit-interval').value) || 0;
                card.due = Date.now() + (card.interval * 86400000);
                DB.updateCard(card);
                this.closeEditModal();
                UI.toast('Card updated!');
                Router.nav('browse');
            },
            closeEditModal() {
                document.getElementById('edit-modal').classList.add('hidden');
            }
        };

        // ========== STATS ==========
        const Stats = {
            chart: null,
            renderChart() {
                const ctx = document.getElementById('stats-chart');
                if (!ctx) return;
                if (this.chart) this.chart.destroy();

                const counts = DB.getCounts();
                const isDark = Theme.isDark();

                this.chart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['New', 'Learning', 'Review'],
                        datasets: [{
                            data: [counts.new, counts.learning, counts.review],
                            backgroundColor: ['#007AFF', '#FF9500', '#34C759'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { color: isDark ? '#F5F5F7' : '#1D1D1F', padding: 20, font: { size: 14 } }
                            }
                        }
                    }
                });
            }
        };

        // ========== STUDY ==========
        const Study = {
            queue: [],
            currentIndex: 0,
            showingAnswer: false,
            currentDeckId: null,
            start(deckId = null) {
                this.currentDeckId = deckId;
                this.queue = DB.getDueCards(deckId);
                this.currentIndex = 0;
                this.showingAnswer = false;
                Router.nav('study', deckId);
            },
            revealCloze(el) {
                el.innerHTML = el.dataset.text;
                el.className = 'cloze-revealed';
            },
            showAnswer() {
                this.showingAnswer = true;
                this.render();
            },
            answer(quality) {
                if (this.queue.length === 0) return;
                let card = this.queue[this.currentIndex];
                card = Scheduler.answer(card, quality);
                DB.updateCard(card);
                this.queue.splice(this.currentIndex, 1);
                if (this.currentIndex >= this.queue.length) this.currentIndex = 0;
                this.showingAnswer = false;
                this.render();
            },
            render() {
                const vp = document.getElementById('app-viewport');
                if (this.queue.length === 0) {
                    vp.innerHTML = \`
                        <div class="w-full max-w-xl mx-auto p-4 pt-8 animate-fade-in text-center">
                            <div class="text-6xl mb-4">ðŸŽ‰</div>
                            <h2 class="text-2xl font-bold mb-2">Congratulations!</h2>
                            <p class="text-gray-500 dark:text-gray-400 mb-6">You have finished all due cards.</p>
                            <button onclick="Router.nav('decks')" class="bg-anki-blue text-white px-6 py-3 rounded-lg font-medium">Back to Decks</button>
                        </div>
                    \`;
                    return;
                }
                const card = this.queue[this.currentIndex];
                const deck = DB.getDeckById(card.deckId);
                const frontHtml = Cloze.renderForStudy(card.front, this.showingAnswer);
                const remaining = this.queue.length;

                let controls = '';
                if (!this.showingAnswer) {
                    controls = \`
                        <div class="mt-6">
                            <button onclick="Study.showAnswer()" class="w-full bg-anki-blue text-white py-4 rounded-xl font-semibold text-lg hover:bg-blue-600 transition-colors">
                                Show Answer <span class="text-blue-200 ml-2">(Space)</span>
                            </button>
                        </div>
                    \`;
                } else {
                    controls = \`
                        <div class="mt-4 p-4 bg-gray-100 dark:bg-[#1C1C1E] rounded-xl">
                            <div class="text-sm text-gray-500 mb-2">Back:</div>
                            <div class="text-lg">\${Utils.escapeHtml(card.back)}</div>
                        </div>
                        <div class="mt-6 grid grid-cols-4 gap-2">
                            <button onclick="Study.answer(0)" class="bg-anki-red text-white py-3 rounded-xl font-medium text-sm hover:opacity-90">
                                Again<br><span class="text-xs opacity-75">\${Scheduler.getIntervalText(card, 0)}</span>
                            </button>
                            <button onclick="Study.answer(1)" class="bg-anki-orange text-white py-3 rounded-xl font-medium text-sm hover:opacity-90">
                                Hard<br><span class="text-xs opacity-75">\${Scheduler.getIntervalText(card, 1)}</span>
                            </button>
                            <button onclick="Study.answer(2)" class="bg-anki-green text-white py-3 rounded-xl font-medium text-sm hover:opacity-90">
                                Good<br><span class="text-xs opacity-75">\${Scheduler.getIntervalText(card, 2)}</span>
                            </button>
                            <button onclick="Study.answer(3)" class="bg-anki-blue text-white py-3 rounded-xl font-medium text-sm hover:opacity-90">
                                Easy<br><span class="text-xs opacity-75">\${Scheduler.getIntervalText(card, 3)}</span>
                            </button>
                        </div>
                        <div class="text-center text-xs text-gray-400 mt-2">Keys: 1=Again, 2=Hard, 3=Good, 4=Easy</div>
                    \`;
                }

                vp.innerHTML = \`
                    <div class="w-full max-w-xl mx-auto p-4 pt-4 animate-fade-in">
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-sm text-gray-500">\${deck ? deck.name : 'All Decks'}</span>
                            <span class="text-sm font-medium text-anki-blue">\${remaining} remaining</span>
                        </div>
                        <div class="card-display mb-4">
                            <div>\${frontHtml}</div>
                        </div>
                        \${controls}
                    </div>
                \`;
            }
        };

        // ========== ROUTER ==========
        const Router = {
            currentPage: 'decks',
            nav(page, param = null) {
                this.currentPage = page;
                document.querySelectorAll('.nav-btn').forEach(b => {
                    b.classList.remove('bg-white', 'shadow-sm', 'text-black', 'dark:bg-[#505050]', 'dark:text-white');
                    b.classList.add('text-gray-500');
                });
                const btn = document.getElementById('nav-' + page);
                if (btn) {
                    btn.classList.add('bg-white', 'shadow-sm', 'text-black', 'dark:bg-[#505050]', 'dark:text-white');
                    btn.classList.remove('text-gray-500');
                }
                const vp = document.getElementById('app-viewport');
                vp.scrollTop = 0;

                switch(page) {
                    case 'decks': this.renderDecks(vp); break;
                    case 'add': this.renderAdd(vp); break;
                    case 'browse': this.renderBrowse(vp); break;
                    case 'study': Study.render(); break;
                    case 'stats': this.renderStats(vp); break;
                    default: this.renderDecks(vp);
                }
            },
            renderDecks(vp) {
                const decks = DB.data.decks;
                let rows = decks.map(d => {
                    const counts = DB.getCounts(d.id);
                    return \`
                        <tr class="cursor-pointer" onclick="Study.start('\${d.id}')">
                            <td class="font-medium">\${Utils.escapeHtml(d.name)}</td>
                            <td><span class="text-anki-blue font-semibold">\${counts.new}</span></td>
                            <td><span class="text-anki-orange font-semibold">\${counts.learning}</span></td>
                            <td><span class="text-anki-green font-semibold">\${counts.review}</span></td>
                            <td class="text-right">
                                <button onclick="event.stopPropagation(); Router.editDeck('\${d.id}')" class="text-gray-400 hover:text-anki-blue px-2"><i class="fa-solid fa-pen"></i></button>
                                <button onclick="event.stopPropagation(); Router.deleteDeck('\${d.id}')" class="text-gray-400 hover:text-anki-red px-2"><i class="fa-solid fa-trash"></i></button>
                            </td>
                        </tr>
                    \`;
                }).join('');

                vp.innerHTML = \`
                    <div class="w-full max-w-3xl mx-auto p-4 animate-fade-in">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold">Your Decks</h2>
                            <button onclick="Router.addDeck()" class="bg-anki-blue text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-600">
                                <i class="fa-solid fa-plus mr-1"></i> New Deck
                            </button>
                        </div>
                        <div class="overflow-x-auto rounded-xl border border-light-border dark:border-dark-border">
                            <table class="anki-table">
                                <thead><tr><th>Deck</th><th>New</th><th>Learn</th><th>Due</th><th></th></tr></thead>
                                <tbody>\${rows || '<tr><td colspan="5" class="text-center text-gray-500 py-8">No decks yet</td></tr>'}</tbody>
                            </table>
                        </div>
                        <div class="mt-4">
                            <button onclick="Study.start()" class="w-full bg-anki-green text-white py-3 rounded-xl font-semibold hover:bg-green-600">
                                <i class="fa-solid fa-graduation-cap mr-2"></i> Study All Due Cards
                            </button>
                        </div>
                    </div>
                \`;
            },
            addDeck() {
                const name = prompt('Enter deck name:');
                if (name && name.trim()) {
                    DB.addDeck(name);
                    UI.toast('Deck created!');
                    this.nav('decks');
                }
            },
            editDeck(id) {
                const deck = DB.getDeckById(id);
                if (!deck) return;
                const name = prompt('Edit deck name:', deck.name);
                if (name && name.trim()) {
                    DB.updateDeck(id, { name: name.trim() });
                    UI.toast('Deck updated!');
                    this.nav('decks');
                }
            },
            deleteDeck(id) {
                if (confirm('Delete this deck and all its cards?')) {
                    DB.deleteDeck(id);
                    UI.toast('Deck deleted!');
                    this.nav('decks');
                }
            },
            renderAdd(vp) {
                const decks = DB.data.decks;
                const options = decks.map(d => \`<option value="\${d.id}">\${Utils.escapeHtml(d.name)}</option>\`).join('');

                vp.innerHTML = \`
                    <div class="w-full max-w-xl mx-auto p-4 animate-fade-in">
                        <h2 class="text-xl font-bold mb-4">Add New Card</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">Deck</label>
                                <select id="add-deck" class="w-full p-3 rounded-lg border border-light-border dark:border-dark-border bg-white dark:bg-[#1C1C1E]">
                                    \${options}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Front (supports Cloze: right-click for menu)</label>
                                <div id="add-front" class="editor-field" contenteditable="true" oncontextmenu="UI.showContextMenu(event)"></div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Back</label>
                                <div id="add-back" class="editor-field" contenteditable="true"></div>
                            </div>
                            <div class="bg-gray-100 dark:bg-[#1C1C1E] p-4 rounded-lg">
                                <div class="text-sm font-medium mb-2">Preview:</div>
                                <div id="add-preview" class="text-gray-600 dark:text-gray-400"></div>
                            </div>
                            <button onclick="Router.saveCard()" class="w-full bg-anki-blue text-white py-3 rounded-xl font-semibold hover:bg-blue-600">
                                <i class="fa-solid fa-plus mr-2"></i> Add Card
                            </button>
                        </div>
                    </div>
                \`;

                const frontField = document.getElementById('add-front');
                frontField.addEventListener('input', () => {
                    document.getElementById('add-preview').innerHTML = Cloze.renderForPreview(frontField.innerText);
                });
            },
            saveCard() {
                const deckId = document.getElementById('add-deck').value;
                const front = document.getElementById('add-front').innerText.trim();
                const back = document.getElementById('add-back').innerText.trim();

                if (!front) { UI.toast('Front is required!'); return; }
                if (!deckId) { UI.toast('Select a deck!'); return; }

                DB.addCard({ deckId, front, back });
                UI.toast('Card added!');
                document.getElementById('add-front').innerText = '';
                document.getElementById('add-back').innerText = '';
                document.getElementById('add-preview').innerHTML = '';
            },
            renderBrowse(vp) {
                const cards = DB.data.cards;
                let rows = cards.map(c => {
                    const deck = DB.getDeckById(c.deckId);
                    const frontPreview = c.front.length > 50 ? c.front.substring(0, 50) + '...' : c.front;
                    return \`
                        <tr>
                            <td>\${Utils.escapeHtml(deck ? deck.name : 'Unknown')}</td>
                            <td>\${Utils.escapeHtml(frontPreview)}</td>
                            <td><span class="px-2 py-1 rounded text-xs font-medium \${c.state === 'new' ? 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200' : c.state === 'learning' ? 'bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200' : 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200'}">\${c.state}</span></td>
                            <td>\${Utils.formatInterval(c.interval)}</td>
                            <td class="text-right">
                                <button onclick="UI.openEditModal('\${c.id}')" class="text-gray-400 hover:text-anki-blue px-2"><i class="fa-solid fa-pen"></i></button>
                                <button onclick="Router.deleteCard('\${c.id}')" class="text-gray-400 hover:text-anki-red px-2"><i class="fa-solid fa-trash"></i></button>
                            </td>
                        </tr>
                    \`;
                }).join('');

                vp.innerHTML = \`
                    <div class="w-full max-w-4xl mx-auto p-4 animate-fade-in">
                        <h2 class="text-xl font-bold mb-4">Browse Cards (\${cards.length})</h2>
                        <div class="overflow-x-auto rounded-xl border border-light-border dark:border-dark-border">
                            <table class="anki-table">
                                <thead><tr><th>Deck</th><th>Front</th><th>State</th><th>Interval</th><th></th></tr></thead>
                                <tbody>\${rows || '<tr><td colspan="5" class="text-center text-gray-500 py-8">No cards yet</td></tr>'}</tbody>
                            </table>
                        </div>
                    </div>
                \`;
            },
            deleteCard(id) {
                if (confirm('Delete this card?')) {
                    DB.deleteCard(id);
                    UI.toast('Card deleted!');
                    this.nav('browse');
                }
            },
            renderStats(vp) {
                const counts = DB.getCounts();
                const totalReviews = DB.data.cards.reduce((sum, c) => sum + (c.reviews || 0), 0);

                vp.innerHTML = \`
                    <div class="w-full max-w-xl mx-auto p-4 animate-fade-in">
                        <h2 class="text-xl font-bold mb-4">Statistics</h2>
                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div class="bg-white dark:bg-[#2C2C2E] p-4 rounded-xl border border-light-border dark:border-dark-border">
                                <div class="text-2xl font-bold text-anki-blue">\${counts.total}</div>
                                <div class="text-sm text-gray-500">Total Cards</div>
                            </div>
                            <div class="bg-white dark:bg-[#2C2C2E] p-4 rounded-xl border border-light-border dark:border-dark-border">
                                <div class="text-2xl font-bold text-anki-green">\${totalReviews}</div>
                                <div class="text-sm text-gray-500">Total Reviews</div>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-[#2C2C2E] p-4 rounded-xl border border-light-border dark:border-dark-border">
                            <h3 class="font-semibold mb-4">Card Distribution</h3>
                            <div style="height: 250px;">
                                <canvas id="stats-chart"></canvas>
                            </div>
                        </div>
                        <div class="mt-4 bg-white dark:bg-[#2C2C2E] p-4 rounded-xl border border-light-border dark:border-dark-border">
                            <h3 class="font-semibold mb-2">Today's Summary</h3>
                            <div class="flex justify-between text-sm">
                                <span>New: <strong class="text-anki-blue">\${counts.new}</strong></span>
                                <span>Learning: <strong class="text-anki-orange">\${counts.learning}</strong></span>
                                <span>Due: <strong class="text-anki-green">\${counts.review}</strong></span>
                            </div>
                        </div>
                    </div>
                \`;
                setTimeout(() => Stats.renderChart(), 100);
            }
        };

        // ========== KEYBOARD SHORTCUTS ==========
        document.addEventListener('keydown', (e) => {
            if (e.target.isContentEditable || e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                if (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 'c') {
                    e.preventDefault();
                    Cloze.insertClozeWithSelection();
                }
                return;
            }

            if (Router.currentPage === 'study') {
                if (e.code === 'Space' && !Study.showingAnswer) {
                    e.preventDefault();
                    Study.showAnswer();
                } else if (Study.showingAnswer) {
                    if (e.key === '1') Study.answer(0);
                    else if (e.key === '2') Study.answer(1);
                    else if (e.key === '3') Study.answer(2);
                    else if (e.key === '4') Study.answer(3);
                    else if (e.code === 'Space') Study.answer(2);
                }
            }
        });

        document.addEventListener('click', (e) => {
            if (!e.target.closest('#context-menu')) UI.hideContextMenu();
        });

        // ========== INIT ==========
        document.addEventListener('DOMContentLoaded', () => {
            Theme.init();
            DB.init();
            Router.nav('decks');
        });

        // ========== SERVICE WORKER (Inline) ==========
        if ('serviceWorker' in navigator) {
            const swCode = \`
                const CACHE_NAME = 'anki-pro-v1';
                const urlsToCache = ['/'];
                self.addEventListener('install', e => {
                    e.waitUntil(caches.open(CACHE_NAME).then(cache => cache.addAll(urlsToCache)));
                });
                self.addEventListener('fetch', e => {
                    e.respondWith(caches.match(e.request).then(r => r || fetch(e.request)));
                });
            \`;
            const blob = new Blob([swCode], { type: 'application/javascript' });
            navigator.serviceWorker.register(URL.createObjectURL(blob)).catch(() => {});
        }
    </script>
</body>
</html>