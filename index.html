<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anki iOS Clone</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #007aff;
            --secondary: #5856d6;
            --danger: #ff3b30;
            --warning: #ff9500;
            --success: #34c759;
            --background: #000000;
            --card-bg: #1c1c1e;
            --text: #ffffff;
            --text-secondary: #8e8e93;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--background);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
            position: relative;
        }

        .app-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: rgba(28, 28, 30, 0.9);
            backdrop-filter: blur(20px);
            padding: 12px 16px;
            padding-top: env(safe-area-inset-top);
            border-bottom: 1px solid #2c2c2e;
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 100;
        }

        .content {
            flex: 1;
            overflow-y: auto;
            padding-top: 60px;
            padding-bottom: 80px;
        }

        .tab-bar {
            position: fixed;
            bottom: 0;
            width: 100%;
            background: rgba(28, 28, 30, 0.9);
            backdrop-filter: blur(20px);
            border-top: 1px solid #2c2c2e;
            display: flex;
            padding-bottom: env(safe-area-inset-bottom);
            z-index: 100;
        }

        .tab-item {
            flex: 1;
            padding: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-size: 12px;
        }

        .tab-item.active {
            color: var(--primary);
        }

        .tab-icon {
            font-size: 24px;
            margin-bottom: 4px;
        }

        .page {
            display: none;
            padding: 16px;
            height: 100%;
        }

        .page.active {
            display: block;
        }

        .deck-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .deck-title {
            font-size: 18px;
            font-weight: 600;
        }

        .deck-stats {
            display: flex;
            gap: 8px;
        }

        .stat {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
        }

        .stat-new {
            background: rgba(0, 122, 255, 0.2);
            color: var(--primary);
        }

        .stat-learn {
            background: rgba(255, 149, 0, 0.2);
            color: var(--warning);
        }

        .stat-review {
            background: rgba(52, 199, 89, 0.2);
            color: var(--success);
        }

        .flashcard {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 24px;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px 0;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .card-content {
            font-size: 20px;
            line-height: 1.5;
            text-align: center;
            width: 100%;
        }

        .review-controls {
            display: flex;
            gap: 8px;
            margin-top: 20px;
        }

        .review-btn {
            flex: 1;
            padding: 16px;
            border-radius: 10px;
            border: none;
            color: white;
            font-weight: 600;
            font-size: 16px;
        }

        .btn-again { background: var(--danger); }
        .btn-hard { background: var(--warning); }
        .btn-good { background: var(--success); }
        .btn-easy { background: var(--primary); }

        .cloze {
            color: var(--primary);
            font-weight: bold;
            background: rgba(0, 122, 255, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .cloze-blank {
            color: var(--primary);
            font-weight: bold;
            border-bottom: 2px dashed var(--primary);
            padding: 0 4px;
        }

        .input-group {
            margin-bottom: 16px;
        }

        .input-label {
            display: block;
            color: var(--text-secondary);
            margin-bottom: 6px;
            font-size: 14px;
        }

        .input-field {
            width: 100%;
            background: var(--card-bg);
            border: 1px solid #2c2c2e;
            border-radius: 10px;
            padding: 12px;
            color: var(--text);
            font-size: 16px;
        }

        textarea.input-field {
            min-height: 100px;
            resize: vertical;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 16px;
            font-size: 16px;
            font-weight: 600;
            width: 100%;
            margin-top: 20px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 24px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .toast {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--card-bg);
            padding: 12px 24px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .toast.show {
            opacity: 1;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .progress-bar {
            height: 4px;
            background: var(--primary);
            position: fixed;
            top: 0;
            left: 0;
            z-index: 101;
        }

        .show-answer-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 16px;
            font-size: 16px;
            font-weight: 600;
            width: 100%;
            margin-top: 20px;
        }

        .header-title {
            font-size: 20px;
            font-weight: 700;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Progress Bar -->
        <div class="progress-bar" id="progressBar"></div>
        
        <!-- Header -->
        <div class="header">
            <div class="header-title" id="headerTitle">Anki iOS</div>
        </div>

        <!-- Content Area -->
        <div class="content" id="content">
            
            <!-- Decks Page -->
            <div class="page active" id="pageDecks">
                <h2 style="font-size: 24px; font-weight: 700; margin-bottom: 20px;">My Decks</h2>
                <div id="decksList"></div>
                <div class="empty-state" id="emptyDecks" style="display: none;">
                    <i class="fas fa-layer-group" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
                    <p>No decks yet. Create your first deck!</p>
                </div>
            </div>

            <!-- Add Page -->
            <div class="page" id="pageAdd">
                <h2 style="font-size: 24px; font-weight: 700; margin-bottom: 20px;">Add Card</h2>
                <div class="input-group">
                    <label class="input-label">Deck</label>
                    <select class="input-field" id="deckSelect">
                        <option value="">Select Deck</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label class="input-label">Card Type</label>
                    <select class="input-field" id="cardType">
                        <option value="basic">Basic</option>
                        <option value="cloze">Cloze</option>
                        <option value="cloze++">Cloze+++</option>
                    </select>
                </div>

                <div id="basicFields">
                    <div class="input-group">
                        <label class="input-label">Front</label>
                        <textarea class="input-field" id="frontText" placeholder="Question"></textarea>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Back</label>
                        <textarea class="input-field" id="backText" placeholder="Answer"></textarea>
                    </div>
                </div>

                <div id="clozeFields" style="display: none;">
                    <div class="input-group">
                        <label class="input-label">Text with Cloze Deletions</label>
                        <textarea class="input-field" id="clozeText" placeholder="Use {{c1::cloze}} for deletions"></textarea>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Extra Info (Optional)</label>
                        <textarea class="input-field" id="clozeExtra" placeholder="Additional information"></textarea>
                    </div>
                </div>

                <div id="clozePlusFields" style="display: none;">
                    <div class="input-group">
                        <label class="input-label">Text with Multiple Cloze</label>
                        <textarea class="input-field" id="clozePlusText" placeholder="Use {{c1::first}}, {{c2::second}}, {{c3::third}}"></textarea>
                    </div>
                </div>

                <button class="btn-primary" onclick="saveCard()">Add Card</button>
            </div>

            <!-- Review Page -->
            <div class="page" id="pageReview">
                <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                    <div style="display: flex; gap: 12px;">
                        <span class="stat stat-new" id="newCount">0</span>
                        <span class="stat stat-learn" id="learnCount">0</span>
                        <span class="stat stat-review" id="reviewCount">0</span>
                    </div>
                    <div style="color: var(--text-secondary);" id="timer">0s</div>
                </div>

                <div class="flashcard" onclick="toggleCard()" id="flashcard">
                    <div class="card-content" id="cardContent">
                        Tap to reveal answer
                    </div>
                </div>

                <div id="showAnswerControls" style="display: none;">
                    <div class="review-controls">
                        <button class="review-btn btn-again" onclick="answer(1)">Again</button>
                        <button class="review-btn btn-hard" onclick="answer(2)">Hard</button>
                        <button class="review-btn btn-good" onclick="answer(3)">Good</button>
                        <button class="review-btn btn-easy" onclick="answer(4)">Easy</button>
                    </div>
                </div>

                <div id="flipControls">
                    <button class="show-answer-btn" onclick="showAnswer()">Show Answer</button>
                </div>
            </div>

            <!-- Stats Page -->
            <div class="page" id="pageStats">
                <h2 style="font-size: 24px; font-weight: 700; margin-bottom: 20px;">Statistics</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="deck-card">
                        <div>
                            <div style="font-size: 32px; font-weight: 700;" id="totalCards">0</div>
                            <div style="color: var(--text-secondary); font-size: 14px;">Total Cards</div>
                        </div>
                    </div>
                    <div class="deck-card">
                        <div>
                            <div style="font-size: 32px; font-weight: 700; color: var(--success);" id="dueToday">0</div>
                            <div style="color: var(--text-secondary); font-size: 14px;">Due Today</div>
                        </div>
                    </div>
                </div>
                <div class="deck-card" style="margin-top: 16px;">
                    <div>
                        <div style="font-size: 32px; font-weight: 700; color: var(--primary);" id="reviewedToday">0</div>
                        <div style="color: var(--text-secondary); font-size: 14px;">Reviewed Today</div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Tab Bar -->
        <div class="tab-bar">
            <div class="tab-item active" onclick="showPage('pageDecks')">
                <i class="fas fa-layer-group tab-icon"></i>
                <span>Decks</span>
            </div>
            <div class="tab-item" onclick="showPage('pageAdd')">
                <i class="fas fa-plus-circle tab-icon"></i>
                <span>Add</span>
            </div>
            <div class="tab-item" onclick="showPage('pageReview')">
                <i class="fas fa-play-circle tab-icon"></i>
                <span>Review</span>
            </div>
            <div class="tab-item" onclick="showPage('pageStats')">
                <i class="fas fa-chart-bar tab-icon"></i>
                <span>Stats</span>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // Database
        let db;
        const DB_NAME = 'AnkiDB';
        const DB_VERSION = 1;

        // App State
        let currentDeck = null;
        let currentCard = null;
        let currentNote = null;
        let studyQueue = [];
        let isAnswerShown = false;
        let startTime = null;
        let timerInterval = null;

        // Initialize Database
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onupgradeneeded = (e) => {
                    db = e.target.result;

                    if (!db.objectStoreNames.contains('decks')) {
                        const deckStore = db.createObjectStore('decks', { keyPath: 'id' });
                        deckStore.createIndex('name', 'name', { unique: true });
                    }

                    if (!db.objectStoreNames.contains('notes')) {
                        const noteStore = db.createObjectStore('notes', { keyPath: 'id' });
                        noteStore.createIndex('deckId', 'deckId');
                    }

                    if (!db.objectStoreNames.contains('cards')) {
                        const cardStore = db.createObjectStore('cards', { keyPath: 'id' });
                        cardStore.createIndex('deckId', 'deckId');
                        cardStore.createIndex('due', 'due');
                        cardStore.createIndex('noteId', 'noteId');
                    }

                    if (!db.objectStoreNames.contains('reviews')) {
                        const reviewStore = db.createObjectStore('reviews', { keyPath: 'id' });
                        reviewStore.createIndex('cardId', 'cardId');
                        reviewStore.createIndex('date', 'date');
                    }

                    // Add default deck
                    const tx = e.target.transaction;
                    const decks = tx.objectStore('decks');
                    decks.add({ id: 1, name: 'Default', created: Date.now() });
                };

                request.onsuccess = (e) => {
                    db = e.target.result;
                    resolve();
                };

                request.onerror = (e) => {
                    reject(e.target.error);
                };
            });
        }

        // Database Operations
        function dbOp(storeName, mode, operation) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(storeName, mode);
                const store = tx.objectStore(storeName);
                
                const request = operation(store);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async function getAll(storeName) {
            return dbOp(storeName, 'readonly', store => store.getAll());
        }

        async function add(storeName, item) {
            return dbOp(storeName, 'readwrite', store => store.add(item));
        }

        async function put(storeName, item) {
            return dbOp(storeName, 'readwrite', store => store.put(item));
        }

        async function get(storeName, key) {
            return dbOp(storeName, 'readonly', store => store.get(key));
        }

        async function remove(storeName, key) {
            return dbOp(storeName, 'readwrite', store => store.delete(key));
        }

        // Scheduler (SM-2 Algorithm)
        const scheduler = {
            again: (card) => {
                card.easeFactor = Math.max(1300, card.easeFactor - 200);
                card.interval = 1;
                card.due = Date.now() + 60000; // 1 minute
                card.type = 1; // Learning
                return card;
            },

            hard: (card) => {
                card.easeFactor = Math.max(1300, card.easeFactor - 150);
                card.interval = card.interval * 1.2;
                card.due = Date.now() + card.interval * 60000;
                return card;
            },

            good: (card) => {
                card.interval = Math.max(1, Math.floor(card.interval * (card.easeFactor / 1000)));
                card.due = Date.now() + card.interval * 86400000; // Convert to milliseconds
                return card;
            },

            easy: (card) => {
                card.easeFactor = Math.min(5000, card.easeFactor + 150);
                card.interval = Math.max(1, Math.floor(card.interval * (card.easeFactor / 1000) * 1.3));
                card.due = Date.now() + card.interval * 86400000;
                return card;
            }
        };

        // UI Functions
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function showPage(pageId) {
            // Update tab bar
            document.querySelectorAll('.tab-item').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Update pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Show selected page
            document.getElementById(pageId).classList.add('active');
            
            // Update header
            const titles = {
                'pageDecks': 'My Decks',
                'pageAdd': 'Add Card',
                'pageReview': 'Study',
                'pageStats': 'Statistics'
            };
            
            document.getElementById('headerTitle').textContent = titles[pageId];
            
            // Load data for page
            switch(pageId) {
                case 'pageDecks':
                    loadDecks();
                    break;
                case 'pageAdd':
                    loadDeckSelect();
                    setupCardType();
                    break;
                case 'pageStats':
                    loadStats();
                    break;
            }
        }

        async function loadDecks() {
            try {
                const decks = await getAll('decks');
                const decksList = document.getElementById('decksList');
                const emptyDecks = document.getElementById('emptyDecks');
                
                if (decks.length === 0) {
                    decksList.innerHTML = '';
                    emptyDecks.style.display = 'block';
                    return;
                }
                
                emptyDecks.style.display = 'none';
                
                let html = '';
                for (const deck of decks) {
                    const cards = await getAll('cards');
                    const deckCards = cards.filter(c => c.deckId === deck.id);
                    
                    const now = Date.now();
                    const newCards = deckCards.filter(c => c.type === 0).length;
                    const learningCards = deckCards.filter(c => c.type === 1 && c.due > now).length;
                    const reviewCards = deckCards.filter(c => c.type === 2 && c.due <= now).length;
                    
                    html += `
                        <div class="deck-card" onclick="startStudy(${deck.id})">
                            <div>
                                <div class="deck-title">${deck.name}</div>
                                <div style="color: var(--text-secondary); font-size: 14px; margin-top: 4px;">
                                    ${deckCards.length} cards
                                </div>
                            </div>
                            <div class="deck-stats">
                                ${newCards > 0 ? `<span class="stat stat-new">${newCards}</span>` : ''}
                                ${learningCards > 0 ? `<span class="stat stat-learn">${learningCards}</span>` : ''}
                                ${reviewCards > 0 ? `<span class="stat stat-review">${reviewCards}</span>` : ''}
                            </div>
                        </div>
                    `;
                }
                
                decksList.innerHTML = html;
            } catch (error) {
                showToast('Error loading decks');
            }
        }

        async function loadDeckSelect() {
            const decks = await getAll('decks');
            const select = document.getElementById('deckSelect');
            
            select.innerHTML = '<option value="">Select Deck</option>';
            decks.forEach(deck => {
                const option = document.createElement('option');
                option.value = deck.id;
                option.textContent = deck.name;
                select.appendChild(option);
            });
        }

        function setupCardType() {
            const cardType = document.getElementById('cardType');
            const basicFields = document.getElementById('basicFields');
            const clozeFields = document.getElementById('clozeFields');
            const clozePlusFields = document.getElementById('clozePlusFields');
            
            cardType.addEventListener('change', () => {
                const value = cardType.value;
                
                basicFields.style.display = 'none';
                clozeFields.style.display = 'none';
                clozePlusFields.style.display = 'none';
                
                if (value === 'basic') {
                    basicFields.style.display = 'block';
                } else if (value === 'cloze') {
                    clozeFields.style.display = 'block';
                } else if (value === 'cloze++') {
                    clozePlusFields.style.display = 'block';
                }
            });
        }

        async function saveCard() {
            try {
                const deckId = parseInt(document.getElementById('deckSelect').value);
                const cardType = document.getElementById('cardType').value;
                
                if (!deckId) {
                    showToast('Please select a deck');
                    return;
                }
                
                const noteId = Date.now();
                let note = {
                    id: noteId,
                    deckId: deckId,
                    type: cardType,
                    created: Date.now()
                };
                
                if (cardType === 'basic') {
                    const front = document.getElementById('frontText').value.trim();
                    const back = document.getElementById('backText').value.trim();
                    
                    if (!front) {
                        showToast('Front text is required');
                        return;
                    }
                    
                    note.fields = [front, back];
                    
                    // Create card
                    const card = {
                        id: Date.now(),
                        noteId: noteId,
                        deckId: deckId,
                        type: 0, // New
                        easeFactor: 2500,
                        interval: 0,
                        due: Date.now(),
                        reviews: 0,
                        lapses: 0
                    };
                    
                    await add('cards', card);
                    
                } else if (cardType === 'cloze' || cardType === 'cloze++') {
                    const text = cardType === 'cloze' 
                        ? document.getElementById('clozeText').value.trim()
                        : document.getElementById('clozePlusText').value.trim();
                    
                    const extra = cardType === 'cloze' 
                        ? document.getElementById('clozeExtra').value.trim()
                        : '';
                    
                    if (!text) {
                        showToast('Text is required');
                        return;
                    }
                    
                    note.fields = [text, extra];
                    
                    // Extract cloze numbers
                    const clozeRegex = /\{\{c(\d+)::(.*?)\}\}/g;
                    const matches = [...text.matchAll(clozeRegex)];
                    const clozeNumbers = [...new Set(matches.map(m => parseInt(m[1])))];
                    
                    if (clozeNumbers.length === 0) {
                        showToast('No cloze deletions found');
                        return;
                    }
                    
                    // Create cards for each cloze
                    for (const num of clozeNumbers) {
                        const card = {
                            id: Date.now() + num,
                            noteId: noteId,
                            deckId: deckId,
                            clozeNumber: num,
                            type: 0,
                            easeFactor: 2500,
                            interval: 0,
                            due: Date.now(),
                            reviews: 0,
                            lapses: 0
                        };
                        
                        await add('cards', card);
                    }
                }
                
                await add('notes', note);
                
                // Clear form
                document.getElementById('frontText').value = '';
                document.getElementById('backText').value = '';
                document.getElementById('clozeText').value = '';
                document.getElementById('clozeExtra').value = '';
                document.getElementById('clozePlusText').value = '';
                
                showToast('Card added successfully');
                
                // Update decks list
                loadDecks();
                
            } catch (error) {
                console.error(error);
                showToast('Error saving card');
            }
        }

        async function startStudy(deckId) {
            currentDeck = deckId;
            
            // Get deck info
            const deck = await get('decks', deckId);
            document.getElementById('headerTitle').textContent = `Studying: ${deck.name}`;
            
            // Build study queue
            const cards = await getAll('cards');
            const now = Date.now();
            
            studyQueue = cards.filter(card => 
                card.deckId === deckId && 
                (card.type === 1 || card.due <= now)
            );
            
            if (studyQueue.length === 0) {
                showToast('No cards to review!');
                showPage('pageDecks');
                return;
            }
            
            // Update counts
            const newCards = cards.filter(c => c.deckId === deckId && c.type === 0).length;
            const learningCards = cards.filter(c => c.deckId === deckId && c.type === 1).length;
            const reviewCards = cards.filter(c => c.deckId === deckId && c.type === 2 && c.due <= now).length;
            
            document.getElementById('newCount').textContent = newCards;
            document.getElementById('learnCount').textContent = learningCards;
            document.getElementById('reviewCount').textContent = reviewCards;
            
            // Show review page
            showPage('pageReview');
            
            // Start timer
            startTime = Date.now();
            timerInterval = setInterval(updateTimer, 1000);
            
            // Load first card
            nextCard();
        }

        async function nextCard() {
            if (studyQueue.length === 0) {
                showToast('All cards reviewed!');
                showPage('pageDecks');
                clearInterval(timerInterval);
                return;
            }
            
            currentCard = studyQueue.shift();
            currentNote = await get('notes', currentCard.noteId);
            isAnswerShown = false;
            
            renderCardFront();
            
            document.getElementById('showAnswerControls').style.display = 'none';
            document.getElementById('flipControls').style.display = 'block';
        }

        function renderCardFront() {
            const content = document.getElementById('cardContent');
            
            if (!currentNote) {
                content.innerHTML = 'Error loading card';
                return;
            }
            
            if (currentNote.type === 'basic') {
                content.innerHTML = formatText(currentNote.fields[0]);
            } else if (currentNote.type === 'cloze' || currentNote.type === 'cloze++') {
                let text = currentNote.fields[0];
                const clozeNum = currentCard.clozeNumber || 1;
                
                // Hide the current cloze
                const regex = new RegExp(`\\{\\{c${clozeNum}::(.*?)\\}\\}`, 'g');
                text = text.replace(regex, '<span class="cloze-blank">[...]</span>');
                
                // Show other clozes
                text = text.replace(/\{\{c\d+::(.*?)\}\}/g, '$1');
                
                content.innerHTML = formatText(text);
                
                // Add extra info if exists
                if (currentNote.fields[1]) {
                    content.innerHTML += `<div style="margin-top: 20px; color: var(--text-secondary); font-size: 16px;">${formatText(currentNote.fields[1])}</div>`;
                }
            }
        }

        function renderCardBack() {
            const content = document.getElementById('cardContent');
            
            if (currentNote.type === 'basic') {
                content.innerHTML = `
                    <div style="text-align: left;">
                        <div style="margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #2c2c2e;">
                            ${formatText(currentNote.fields[0])}
                        </div>
                        <div>${formatText(currentNote.fields[1])}</div>
                    </div>
                `;
            } else if (currentNote.type === 'cloze' || currentNote.type === 'cloze++') {
                let text = currentNote.fields[0];
                const clozeNum = currentCard.clozeNumber || 1;
                
                // Highlight current cloze
                const regex = new RegExp(`\\{\\{c${clozeNum}::(.*?)\\}\\}`, 'g');
                text = text.replace(regex, '<span class="cloze">$1</span>');
                
                // Show other clozes
                text = text.replace(/\{\{c\d+::(.*?)\}\}/g, '$1');
                
                content.innerHTML = formatText(text);
                
                if (currentNote.fields[1]) {
                    content.innerHTML += `<div style="margin-top: 20px; color: var(--text-secondary); font-size: 16px;">${formatText(currentNote.fields[1])}</div>`;
                }
            }
        }

        function showAnswer() {
            isAnswerShown = true;
            renderCardBack();
            document.getElementById('showAnswerControls').style.display = 'block';
            document.getElementById('flipControls').style.display = 'none';
        }

        function toggleCard() {
            if (isAnswerShown) {
                renderCardFront();
                isAnswerShown = false;
                document.getElementById('showAnswerControls').style.display = 'none';
                document.getElementById('flipControls').style.display = 'block';
            } else {
                showAnswer();
            }
        }

        async function answer(rating) {
            try {
                // Update card based on rating
                const now = Date.now();
                
                // Log review
                const review = {
                    id: Date.now(),
                    cardId: currentCard.id,
                    rating: rating,
                    time: Math.floor((now - startTime) / 1000),
                    date: now
                };
                
                await add('reviews', review);
                
                // Update card scheduling
                currentCard.reviews = (currentCard.reviews || 0) + 1;
                currentCard.lastReview = now;
                
                // Apply scheduler
                if (rating === 1) {
                    currentCard = scheduler.again(currentCard);
                    currentCard.lapses = (currentCard.lapses || 0) + 1;
                } else if (rating === 2) {
                    currentCard = scheduler.hard(currentCard);
                } else if (rating === 3) {
                    currentCard = scheduler.good(currentCard);
                } else if (rating === 4) {
                    currentCard = scheduler.easy(currentCard);
                }
                
                // Save updated card
                await put('cards', currentCard);
                
                // Reset timer for next card
                startTime = Date.now();
                
                // Next card
                nextCard();
                
            } catch (error) {
                console.error(error);
                showToast('Error saving answer');
            }
        }

        function updateTimer() {
            if (!startTime) return;
            
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            
            document.getElementById('timer').textContent = 
                `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        function formatText(text) {
            return text
                .replace(/\n/g, '<br>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>');
        }

        async function loadStats() {
            try {
                const cards = await getAll('cards');
                const now = Date.now();
                const todayStart = new Date();
                todayStart.setHours(0, 0, 0, 0);
                
                // Total cards
                document.getElementById('totalCards').textContent = cards.length;
                
                // Due today
                const dueToday = cards.filter(card => 
                    card.due <= now && (card.type === 1 || card.type === 2)
                ).length;
                document.getElementById('dueToday').textContent = dueToday;
                
                // Reviewed today
                const reviews = await getAll('reviews');
                const reviewedToday = reviews.filter(review => 
                    review.date >= todayStart.getTime()
                ).length;
                document.getElementById('reviewedToday').textContent = reviewedToday;
                
            } catch (error) {
                showToast('Error loading stats');
            }
        }

        // Initialize app
        window.onload = async function() {
            try {
                await initDB();
                await loadDecks();
                showToast('Anki iOS Ready!');
            } catch (error) {
                showToast('Error initializing app');
            }
        };
    </script>
</body>
</html>